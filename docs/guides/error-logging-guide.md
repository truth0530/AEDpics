# 에러 로깅 가이드

## 1. 설정

### 환경 변수 (.env.local)
```bash
# 에러 로깅 활성화
ENABLE_ERROR_LOGGING=true

# 알림 설정 (선택사항)
DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/...
# SLACK_WEBHOOK_URL=https://hooks.slack.com/services/...
```

### Supabase 테이블 생성 (선택사항)
```sql
-- Supabase SQL Editor에서 실행
CREATE TABLE IF NOT EXISTS error_logs (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  message TEXT NOT NULL,
  stack TEXT,
  context JSONB,
  url TEXT,
  method VARCHAR(10),
  user_id UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 인덱스 추가
CREATE INDEX idx_error_logs_created_at ON error_logs(created_at DESC);
CREATE INDEX idx_error_logs_user_id ON error_logs(user_id);

-- RLS 정책 (관리자만 조회 가능)
ALTER TABLE error_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Admin can view all errors"
  ON error_logs FOR SELECT
  TO authenticated
  USING (
    auth.jwt() ->> 'role' = 'master' OR
    auth.jwt() ->> 'role' = 'admin'
  );
```

## 2. 사용법

### API 라우트에서 에러 로깅
```typescript
// app/api/example/route.ts
import { errorLogger } from '@/lib/monitoring/error-logger';

export async function GET(request: Request) {
  try {
    // API 로직
    const data = await fetchData();
    return NextResponse.json(data);
  } catch (error) {
    // 에러 로깅
    await errorLogger.logApiError(request, error, userId);

    // 클라이언트에는 일반적인 에러 메시지 반환
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

### 서버 컴포넌트에서 에러 로깅
```typescript
// app/page.tsx
import { errorLogger } from '@/lib/monitoring/error-logger';

export default async function Page() {
  try {
    const data = await fetchData();
    return <Component data={data} />;
  } catch (error) {
    await errorLogger.log(error, { page: 'HomePage' });
    return <ErrorComponent />;
  }
}
```

### 클라이언트 컴포넌트에서 에러 로깅
```typescript
// components/ClientComponent.tsx
'use client';

import { useEffect } from 'react';

export default function ClientComponent() {
  useEffect(() => {
    // 글로벌 에러 핸들러
    window.addEventListener('error', (event) => {
      // API 엔드포인트로 에러 전송
      fetch('/api/log-error', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: event.error?.message,
          stack: event.error?.stack,
          url: window.location.href,
        }),
      });
    });
  }, []);

  return <div>Component</div>;
}
```

### 에러 로그 API 엔드포인트
```typescript
// app/api/log-error/route.ts
import { errorLogger } from '@/lib/monitoring/error-logger';

export async function POST(request: Request) {
  try {
    const errorData = await request.json();

    // 클라이언트 에러 로깅
    await errorLogger.log(
      new Error(errorData.message),
      {
        type: 'client',
        url: errorData.url,
        userAgent: request.headers.get('user-agent'),
      }
    );

    return NextResponse.json({ success: true });
  } catch (error) {
    // 로깅 실패는 조용히 처리
    return NextResponse.json({ success: false });
  }
}
```

## 3. 모니터링

### Supabase Dashboard
1. SQL Editor → 에러 조회
```sql
-- 최근 에러 조회
SELECT * FROM error_logs
ORDER BY created_at DESC
LIMIT 100;

-- 특정 사용자 에러
SELECT * FROM error_logs
WHERE user_id = 'USER_ID'
ORDER BY created_at DESC;

-- 에러 빈도 통계
SELECT
  DATE_TRUNC('hour', created_at) as hour,
  COUNT(*) as error_count
FROM error_logs
WHERE created_at > NOW() - INTERVAL '24 hours'
GROUP BY hour
ORDER BY hour DESC;
```

### 자동 알림
- Discord/Slack 웹훅으로 크리티컬 에러 즉시 알림
- 매일 에러 요약 리포트 생성 (크론 작업)

## 4. 베스트 프랙티스

### DO
- ✅ 민감한 정보 제거 (비밀번호, 토큰 등)
- ✅ 구조화된 컨텍스트 정보 포함
- ✅ 에러 레벨 구분 (Critical/Error/Warning)
- ✅ 적절한 샘플링 (너무 많은 로그 방지)

### DON'T
- ❌ 사용자 개인정보 로깅
- ❌ 전체 요청 바디 저장
- ❌ 동일 에러 반복 로깅
- ❌ 로깅으로 인한 성능 저하

## 5. 대안 솔루션

### Sentry (권장)
```bash
npm install @sentry/nextjs

# sentry.client.config.ts
Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: 1.0,
});
```

### Vercel Analytics
- 자동 에러 추적
- Web Vitals 모니터링
- 무료 티어 제공

### LogFlare (Supabase 통합)
- Supabase와 네이티브 통합
- 실시간 로그 스트리밍
- 강력한 쿼리 기능