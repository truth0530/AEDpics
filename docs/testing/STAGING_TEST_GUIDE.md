# 스테이징 환경 테스트 가이드

**테스트 날짜**: 2025-11-10
**테스트 버전**: 716b39c (로그인/로그아웃 성능 및 안정성 개선)
**테스트 환경**: Staging Server
**테스트 담당자**: [이름]

---

## 📋 사전 준비

### 스테이징 서버 배포

```bash
# 1. 스테이징 서버에 접속
ssh user@staging-server

# 2. 애플리케이션 디렉토리로 이동
cd /var/www/aedpics-staging

# 3. 최신 코드 가져오기
git fetch origin
git checkout origin/main

# 4. 의존성 설치 (프로덕션 모드)
npm ci --production

# 5. Prisma 생성
npx prisma generate

# 6. 프로덕션 빌드
NODE_ENV=production npm run build

# 7. 기존 프로세스 중지 (있는 경우)
pm2 delete aedpics-staging || true

# 8. 새 프로세스 시작
pm2 start ecosystem.config.cjs --name aedpics-staging

# 9. PM2 저장
pm2 save

# 10. 배포 완료 확인
pm2 logs --lines 20
```

### 환경 변수 확인

```bash
# 스테이징 .env 파일 확인
cat /var/www/aedpics-staging/.env.local | grep -E "NEXTAUTH|DATABASE|NCP"

# 필수 확인사항:
# ☐ NEXTAUTH_SECRET 설정됨
# ☐ DATABASE_URL 스테이징 DB 포인팅
# ☐ NCP 환경변수 설정됨
```

---

## 🔴 필수 테스트 항목

### Test 1: 로그인 성능 테스트

#### 1.1 정상 로그인 플로우

```
테스트 시나리오: 일반 사용자 로그인
────────────────────────────────────

준비 단계:
  1. 스테이징 환경 접속: https://staging.aed.pics
  2. /auth/signin 페이지 이동
  3. 유효한 테스트 계정 준비
     - 이메일: test@korea.kr
     - 비밀번호: [테스트 비밀번호]

테스트 단계:
  1. 로그인 버튼 클릭 전 성능 메트릭 초기화
     → Chrome DevTools > Performance 탭 열기
     → "Record" 버튼 클릭

  2. 이메일 입력

  3. 비밀번호 입력

  4. 로그인 버튼 클릭 (정확한 시간 기록)
     ↓ 예상: 100ms 내에 스피너 표시
     ☐ 스피너 ("로그인 처리 중...") 표시 여부 확인
     ☐ 스피너 표시 시간 < 200ms (목표: 100ms)

  5. 로딩 진행률 관찰
     ☐ 스피너가 계속 회전 중 (UI 반응)
     ☐ "페이지 이동 중..." 메시지 변경

  6. 대시보드 도착 (최종 시간 기록)
     ☐ 전체 로그인 완료 시간 < 2초 (권장)
     ☐ 실제 측정: ___ ms

  7. Performance 탭에서 "Stop" 클릭
     → 타임라인 분석:
        ☐ authorize 완료 지점
        ☐ setRedirecting(true) 지점
        ☐ 페이지 로드 지점

검증 항목:
  ✅ 로그인 성공
  ✅ 스피너가 빨리 표시됨
  ✅ 전체 시간이 2초 미만
  ✅ UI가 반응 상태 유지 (버벅거리지 않음)

실제 성능 기록:
  스피너 표시 시간: ___ ms
  authorize 완료: ___ ms
  프로필 로드: ___ ms
  전체 완료: ___ ms
```

#### 1.2 느린 네트워크 환경 시뮬레이션

```
테스트 시나리오: 3G 네트워크 환경
──────────────────────────────────

준비 단계:
  1. Chrome DevTools 열기 (F12)
  2. Network 탭 이동
  3. "Throttling" 드롭다운: "3G" 선택
  4. /auth/signin 페이지 새로고침
  5. 테스트 계정 로그인 준비

테스트 단계:
  1. 로그인 버튼 클릭 (정확한 시간 기록)

  2. UI 반응성 관찰 (매우 중요!)
     ☐ 1초 내에 스피너 표시 (기존: 없었음)
     ☐ 스피너가 계속 회전 (버벅거리지 않음)
     ☐ 스피너 UI가 부드러움

  3. 로딩 진행 상황 관찰
     ☐ 스피너 "로그인 처리 중..." (authorize 완료)
     ☐ 스피너 "페이지 이동 중..." (라우팅 진행)

  4. 최종 대시보드 도착
     ☐ 5초 이내에 도착 (3G 환경이므로 조금 길어도 OK)
     ☐ 실제 측정: ___ ms

검증 항목:
  ✅ 스피너가 빨리 표시됨 (UX 개선 확인)
  ✅ 스피너가 계속 움직임 (사용자가 기다림을 앎)
  ✅ 최종적으로 페이지 로드 됨
  ✅ "멈춘 것 같다"는 느낌 없음

실제 성능 기록:
  3G 상황에서 스피너 표시: ___ ms (목표: < 1초)
  전체 완료 시간: ___ ms
  UI 반응성: [부드러움 / 약간 버벅거림 / 심하게 버벅거림]
```

---

### Test 2: 로그아웃 안정성 테스트

#### 2.1 정상 로그아웃

```
테스트 시나리오: 정상 로그아웃
────────────────────────────

준비 단계:
  1. 로그인된 상태 (Test 1에서 진행)
  2. 프로필 드롭다운 메뉴 찾기
  3. "로그아웃" 버튼 위치 확인

테스트 단계:
  1. 로그아웃 버튼 클릭

  2. 요청 모니터링
     → Chrome DevTools > Network 탭
     ☐ /auth/api/callback/signout 요청 확인
     ☐ 요청 상태: 200 OK

  3. 페이지 이동 확인
     ☐ /auth/signin으로 리다이렉트됨
     ☐ 리다이렉트 시간 < 1초

  4. 쿠키 확인
     → Chrome DevTools > Application > Cookies
     ☐ next-auth.session-token 없음 (또는 만료됨)

  5. 콘솔 에러 확인
     → Console 탭
     ☐ 에러 없음
     ☐ 경고 없음

검증 항목:
  ✅ 로그아웃 완료
  ✅ /auth/signin으로 이동
  ✅ 세션 쿠키 삭제됨
  ✅ 콘솔 에러 없음
```

#### 2.2 네트워크 오류 시뮬레이션

```
테스트 시나리오: signOut 요청 차단 (네트워크 오류)
──────────────────────────────────────────────────

준비 단계:
  1. 로그인된 상태
  2. Chrome DevTools > Network 탭 열기
  3. "Offline" 체크박스 활성화 (또는 Network 요청 차단)

테스트 단계 (방법 A: Offline 모드):
  1. 개발자 도구 Network 탭에서 "Offline" 체크
  2. 로그아웃 버튼 클릭
  3. 결과 확인:
     ☐ 네트워크 요청 실패 (빨간색 표시)
     ☐ 2-3초 후 /auth/signin으로 이동 (중요!)
     ☐ 사용자가 갇혀있지 않음

테스트 단계 (방법 B: 요청 차단):
  1. Network 탭 열기
  2. 검색: "signout" 또는 "callback"
  3. 요청 마우스 우클릭 > "Block URL"
  4. 로그아웃 버튼 클릭
  5. 결과 확인:
     ☐ 요청이 차단됨 (빨간색)
     ☐ 2-3초 후 /auth/signin으로 이동
     ☐ 콘솔: "로그아웃 처리 중 오류" 메시지 확인

  6. 콘솔 확인
     ☐ 에러 메시지: "로그아웃 처리 중 오류"
     ☐ 에러가 기록되지만 사용자 영향 없음

검증 항목 (가장 중요!):
  ✅ 네트워크 오류 발생
  ✅ 그럼에도 /auth/signin으로 이동 (에러 처리 작동!)
  ✅ 사용자가 페이지에 갇혀있지 않음 (해결됨!)
  ✅ 콘솔에 에러 로그 기록됨

실제 결과:
  네트워크 오류: [발생함 / 발생하지 않음]
  리다이렉트 여부: [이동함 / 이동하지 않음]
  사용자 갇힘: [아니오 (개선됨!) / 예]
```

#### 2.3 느린 네트워크에서 로그아웃

```
테스트 시나리오: 3G 네트워크에서 로그아웃
────────────────────────────────────────

준비 단계:
  1. 로그인된 상태
  2. Network 탭 > Throttling: "3G"

테스트 단계:
  1. 로그아웃 버튼 클릭

  2. 네트워크 요청 모니터링
     ☐ /callback/signout 요청 보임
     ☐ 3-5초 정도 기다림

  3. 페이지 이동 결과
     ☐ 느린 속도에도 불구하고 /auth/signin으로 이동
     ☐ 최종 이동 시간 < 10초

  4. 콘솔 확인
     ☐ 에러 없음 (또는 타임아웃 등이 있으면 기록)

검증 항목:
  ✅ 느린 네트워크에서도 작동
  ✅ 사용자를 기다리게 함 (UI 반응)
  ✅ 최종적으로 이동
```

---

### Test 3: 민감정보 미노출 확인

#### 3.1 프로필 API 응답 확인

```
테스트 시나리오: 프로필 API에서 민감정보 노출 여부 확인
───────────────────────────────────────────────────

준비 단계:
  1. 로그인 상태
  2. Chrome DevTools > Network 탭 열기
  3. 필터: "profile" 검색

테스트 단계:
  1. 대시보드 또는 프로필 페이지 접속
     ☐ /api/user/profile/[id] 요청 나타남

  2. 요청 클릭 > Response 탭 보기

  3. Response 데이터 확인:

     ✅ 포함되어야 할 필드:
        ☐ id
        ☐ email
        ☐ full_name
        ☐ role
        ☐ organization_id
        ☐ organization_name
        ☐ is_active
        ☐ created_at
        ☐ updated_at
        ☐ organizations

     ❌ 포함되지 말아야 할 필드 (중요!):
        ☐ password_hash (없어야 함!)
        ☐ account_locked (없어야 함!)
        ☐ lock_reason (없어야 함!)
        ☐ approval_status (없어야 함!)
        ☐ login_history (없어야 함!)

  4. 실제 JSON 확인
     예시:
     ```json
     {
       "id": "user-123",
       "email": "test@korea.kr",
       "full_name": "테스트유저",
       "role": "local_admin",
       "organization_id": "org-456",
       "organization_name": "대구광역시 중구보건소",
       "is_active": true,
       "created_at": "2025-11-01T...",
       "updated_at": "2025-11-10T...",
       "organizations": [...]
       // password_hash 없음 ✅
       // account_locked 없음 ✅
     }
     ```

검증 항목:
  ✅ 필요한 필드 모두 포함
  ❌ password_hash 제외됨 (보안!)
  ❌ account_locked 제외됨 (보안!)
  ❌ lock_reason 제외됨 (보안!)
  ✅ organizations 데이터 정상

민감정보 미노출 확인: [완벽 / 일부 노출 / 심각한 노출]
```

---

### Test 4: 프로필 로드 실패 시 폴백

#### 4.1 프로필 API 장애 시뮬레이션

```
테스트 시나리오: 프로필 API가 500 에러 반환
────────────────────────────────────────────

준비 단계:
  1. /auth/signin 페이지에서 로그인 준비
  2. Chrome DevTools > Network 탭 열기

테스트 단계:
  1. Network 탭에서 "profile" 요청 준비
  2. 로그인 버튼 클릭
  3. /api/user/profile/* 요청 나타날 때까지 대기
  4. 요청 마우스 우클릭 > "Block response" (요청 실패로 시뮬레이션)
     또는 다른 방법: 개발자 도구에서 네트워크 요청 차단

  5. 결과 확인:
     ☐ 프로필 요청이 실패함 (500 또는 timeout)
     ☐ 콘솔: "프로필 로드 실패" 메시지 확인
     ☐ 그럼에도 /dashboard로 이동 (폴백 작동!)
     ☐ 대시보드 페이지 열림

검증 항목:
  ✅ 프로필 로드 실패
  ✅ 콘솔 에러 로그 기록됨: "프로필 로드 실패"
  ✅ 그럼에도 /dashboard로 이동 (사용자를 갇히게 하지 않음)
  ✅ 애플리케이션 작동 계속 됨

폴백 작동 여부: [정상 작동 / 미작동]
```

---

## 🟡 권장 추가 테스트

### Test 5: 동시성 테스트

```
테스트 시나리오: 여러 사용자 동시 로그인
──────────────────────────────────────────

준비 단계:
  1. 테스트 계정 3개 이상 준비
  2. 3개의 브라우저 창/탭 준비
  3. 각 탭에서 /auth/signin 열기

테스트 단계:
  1. 각 탭에서 동시에 (또는 1초 간격으로) 로그인 클릭
  2. 각 로그인의 완료 시간 기록
  3. 데이터베이스 확인
     ```sql
     SELECT id, email, login_count, last_login_at
     FROM user_profiles
     WHERE id IN ('user1', 'user2', 'user3')
     ORDER BY last_login_at DESC;
     ```
     ☐ 각 사용자의 login_count가 1씩 증가
     ☐ 중복 기록 없음
     ☐ last_login_at이 정확한 시간 기록됨

검증 항목:
  ✅ 동시성 처리 정상
  ✅ login_count 정확성
  ✅ 데이터 일관성 (중복 없음)
  ✅ 트랜잭션 작동 확인
```

### Test 6: 로그인 통계 확인

```
테스트 시나리오: authorize에서 login_count 증가 확인
─────────────────────────────────────────────────────

준비 단계:
  1. 테스트 계정의 현재 login_count 확인
     ```sql
     SELECT login_count FROM user_profiles WHERE email = 'test@korea.kr';
     ```

테스트 단계:
  1. 로그인 5회 수행
  2. 5회 로그인 완료 후 다시 확인
     ```sql
     SELECT login_count, last_login_at FROM user_profiles WHERE email = 'test@korea.kr';
     ```
     ☐ login_count가 정확히 5 증가함
     ☐ 이중 쓰기가 없음 (중복 기록 없음)

검증 항목:
  ✅ login_count 정확히 증가
  ✅ authorize에서 track-login 중복 호출 없음
  ✅ 트랜잭션으로 원자성 보장
```

---

## 📊 테스트 결과 기록

### 성능 메트릭

| 테스트 항목 | 목표 | 결과 | 합격 |
|----------|------|------|------|
| 스피너 표시 시간 | < 200ms | ___ ms | ☐ |
| 전체 로그인 완료 | < 2000ms | ___ ms | ☐ |
| 3G 환경 완료 | < 5000ms | ___ ms | ☐ |
| 로그아웃 완료 | < 1000ms | ___ ms | ☐ |

### 기능 테스트 결과

| 테스트 항목 | 예상 결과 | 실제 결과 | 합격 |
|----------|---------|---------|------|
| 정상 로그인 | 대시보드 도착 | 도착함 | ☐ |
| 느린 네트워크 로그인 | UI 반응성 유지 | 유지됨 | ☐ |
| 정상 로그아웃 | /auth/signin 이동 | 이동함 | ☐ |
| 네트워크 오류 로그아웃 | 여전히 이동 | 이동함 | ☐ |
| 민감정보 필터링 | password_hash 없음 | 없음 | ☐ |
| 프로필 로드 실패 | /dashboard로 폴백 | 폴백됨 | ☐ |

### 보안 확인

| 항목 | 검증 방법 | 결과 | 합격 |
|------|---------|------|------|
| password_hash 제외 | API 응답 확인 | 제외됨 | ☐ |
| account_locked 제외 | API 응답 확인 | 제외됨 | ☐ |
| lock_reason 제외 | API 응답 확인 | 제외됨 | ☐ |
| approval_status 제외 | API 응답 확인 | 제외됨 | ☐ |

---

## 📝 최종 평가

### 성공 기준

**프로덕션 배포 승인 조건**:
```
모든 필수 테스트 항목 통과:
  ☐ Test 1: 로그인 성능 (정상 + 3G)
  ☐ Test 2: 로그아웃 안정성 (정상 + 네트워크 오류)
  ☐ Test 3: 민감정보 미노출
  ☐ Test 4: 프로필 로드 실패 폴백

성능 목표:
  ☐ 스피너 표시: < 200ms
  ☐ 전체 로그인: < 2초
  ☐ 3G 환경: < 5초

안정성 목표:
  ☐ 네트워크 오류 시에도 사용자 이동
  ☐ 에러 로그 기록됨
  ☐ 데이터 일관성 유지

보안 목표:
  ☐ 민감정보 완전 제외
  ☐ 콘솔 에러 없음 (또는 최소화)
```

### 테스트 결과 요약

**전체 결과**: [ ] 합격 / [ ] 미합격

**발견된 문제**:
```
1. [문제명]
   위치: [파일 및 라인]
   심각도: [높음 / 중간 / 낮음]
   해결책: [방안]

2. [문제명]
   ...
```

**개선 사항 (프로덕션 적용 후)**:
```
1. [항목]
   효과: [개선도]

2. [항목]
   ...
```

---

## ✅ 배포 승인

**테스트 담당자**: ________________
**테스트 날짜**: ________________
**서명 및 날짜**: ________________

**프로덕션 배포 승인**: [ ] 승인 / [ ] 미승인

**미승인 사유 (해당 시 기입)**:
```

```

---

## 다음 단계

### 배포 승인된 경우:
1. 프로덕션 환경에 동일한 변경사항 배포
2. PM2 reload 실행 (무중단 배포)
3. 모니터링 시작 (1시간)

### 미합격 항목이 있는 경우:
1. 문제 분석 및 원인 파악
2. 개발팀에 피드백 전달
3. 수정 후 재테스트

---

## 문의사항

테스트 중 문제가 발생하면:
1. 에러 로그 수집: `pm2 logs --err`
2. 상세 내용 기록
3. 개발팀에 보고

테스트 가이드 개선 사항:
- 이 문서의 어느 부분이 불명확한가?
- 추가로 필요한 테스트 항목이 있는가?
- 테스트 시간을 단축할 방법이 있는가?
