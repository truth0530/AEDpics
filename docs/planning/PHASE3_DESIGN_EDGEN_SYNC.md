# Phase 3: e-gen 동기화 설계

**상태**: 설계 중
**시작일**: 2025-11-07
**완료 예상일**: 2025-11-09
**담당**: 개발팀 (Backend)

---

## 1. 목표

e-gen에서 제공하는 AED 데이터를 정기적으로 동기화하여 최신 AED 정보를 유지하는 시스템 설계

---

## 2. 현황 분석

### 2.1 기존 AED 데이터
```
데이터베이스: NCP PostgreSQL (aedpics_production)
테이블: aed_data
레코드 수: 81,464개
마이그레이션 완료: 2025-10-28
```

### 2.2 e-gen 데이터 (협의 필요)
```
협의 대상: e-gen 담당자
확인 사항:
  □ API 엔드포인트 URL
  □ 인증 방식 (API Key? OAuth?)
  □ 데이터 스키마
  □ 레이트 리미팅 (QPS)
  □ 업데이트 빈도
```

**협의 일정**: Wed or Thu (이번주)

---

## 3. 데이터 스키마 분석

### 3.1 기존 aed_data 테이블 구조

```sql
CREATE TABLE aed_data (
  id BIGINT PRIMARY KEY,
  equipment_serial VARCHAR(50) UNIQUE,
  sido VARCHAR(50),
  gugun VARCHAR(50),
  jurisdiction_health_center VARCHAR(100),
  installation_address TEXT,
  installation_institution VARCHAR(100),
  latitude FLOAT,
  longitude FLOAT,
  access_control VARCHAR(50),
  operation_status VARCHAR(50),
  -- ... 추가 필드
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**총 필드 수**: ~40개 (Prisma schema.prisma 확인 필요)

### 3.2 e-gen 데이터 필드 매핑 (TBD)

```
필드 매핑 테이블:
┌─────────────────────────────┬──────────────────────┬──────────────────┐
│ e-gen 필드                  │ aed_data 필드        │ 변환 로직         │
├─────────────────────────────┼──────────────────────┼──────────────────┤
│ [협의 후 작성]              │ [협의 후 작성]       │ [협의 후 작성]   │
└─────────────────────────────┴──────────────────────┴──────────────────┘
```

**협의 일정**: Wed or Thu

---

## 4. 동기화 전략

### 4.1 옵션 분석

#### Option A: 일일 배치 동기화
```
특징:
  - 매일 정해진 시간에 전체 또는 증분 데이터 동기화
  - 일관성 보장 (atomic)
  - 실시간성 낮음

장점:
  - 구현 단순
  - 데이터베이스 부하 분산 가능
  - 검증 및 롤백 시간 충분

단점:
  - 하루 지연 발생
  - 배치 윈도우 중 장애 발생 가능
  - 스토리지/네트워크 대역폭 요구

권장: ★★★★★ (비용 효율적, 안정성)
```

#### Option B: 실시간 동기화 (Webhook)
```
특징:
  - e-gen의 데이터 변경 시 즉시 동기화
  - 최신성 보장
  - 연동 필요

장점:
  - 실시간성 높음
  - 네트워크 대역폭 효율적

단점:
  - 구현 복잡
  - e-gen Webhook 지원 필요 확인
  - 재시도 로직 필요

권장: ★★☆☆☆ (복잡도 높음)
```

#### Option C: 하이브리드 (일일 + 증분)
```
특징:
  - 평일: 증분 동기화 (04:00 KST 매일)
  - 주말: 전체 동기화 (일요일 02:00 KST)

장점:
  - 실시간성과 안정성 균형
  - 비용 효율적

단점:
  - 구현 중간 수준 복잡

권장: ★★★★☆ (선택 예상)
```

**선정 방식**: TBD (협의 후)

### 4.2 동기화 빈도

```
추천: 일일 배치 동기화 (04:00 KST)

근거:
  - 야간에 배치 진행 (사용자 영향 최소)
  - 아침까지 동기화 완료 (사용자 사용 시간 전)
  - 비용 효율적 (네트워크 트래픽 분산)
  - 데이터 무결성 검증 시간 충분
```

### 4.3 증분 vs 전체 동기화

#### 증분 동기화 (권장)
```
방식:
  - e-gen에서 변경된 데이터만 다운로드
  - timestamp 또는 version 필드로 필터링

장점:
  - 네트워크 트래픽 80% 감소 (예상)
  - 데이터베이스 쓰기 부하 감소
  - 비용 절감

문제점:
  - e-gen이 변경 추적 지원해야 함
  - 첫 동기화는 전체 (이미 완료됨)

실행 계획:
  1. e-gen API에 'last_modified_after' 파라미터 확인
  2. aed_data.updated_at으로 마지막 동기화 시간 추적
  3. 증분 쿼리 작성
```

#### 전체 동기화 (폴백)
```
방식:
  - 매번 전체 데이터 다운로드 및 교체

장점:
  - 구현 단순
  - e-gen API 지원 불필요

단점:
  - 네트워크 트래픽 많음 (81K 레코드 * 2KB = 160MB)
  - 데이터베이스 부하 높음
  - 비용 증가

사용 시나리오:
  - e-gen이 증분 동기화 미지원
  - 주간 1회 또는 월간 1회만 동기화
```

---

## 5. 검증 로직

### 5.1 데이터 무결성 검사

```
검증 단계:

1단계: 형식 검증 (데이터 다운로드 직후)
  ✓ 필수 필드 존재 여부
  ✓ 데이터 타입 확인 (GPS 좌표는 float, 문자는 string 등)
  ✓ 필드 길이 제한 (address < 255 characters)

2단계: 비즈니스 로직 검증 (데이터 정규화 전)
  ✓ 중복 equipment_serial 검사
  ✓ GPS 좌표 유효성 (한국 경계 내인가?)
  ✓ 필수 필드 조합 (sido + gugun 일관성)

3단계: 데이터베이스 검증 (INSERT/UPDATE 전)
  ✓ FK 관계 무결성 (jurisdiction_health_center 존재?)
  ✓ UNIQUE 제약 조건 (equipment_serial 충돌?)
  ✓ 트랜잭션 롤백 준비

4단계: 사후 검증 (동기화 완료 후)
  ✓ 삽입된 레코드 수 확인
  ✓ 수정된 레코드 수 확인
  ✓ 예상치 대비 이상 범위 확인 (±10%)
```

### 5.2 에러 처리 및 롤백

```
시나리오별 대응:

[시나리오 1] 부분 실패 (1000개 중 50개 실패)
  원인: 필드 형식 오류, FK 위반 등
  대응:
    1. 실패 레코드 로깅 (detailed error message)
    2. 성공한 50개는 롤백할지 유지할지 결정
    3. 실패 레코드만 제외하고 진행 (부분 동기화)
    4. 실패 알림 발송 (관리자)

[시나리오 2] 전체 실패 (e-gen API 장애)
  원인: 네트워크 오류, API 다운, 인증 실패
  대응:
    1. 재시도 로직 (3회, 지수 백오프)
    2. 최대 대기: 1시간
    3. 여전히 실패 → 전날 데이터 유지 (fallback)
    4. 심각한 알림 발송 (관리자 + 기술팀)

[시나리오 3] 데이터 손상 감지 (예: 모든 GPS 좌표가 NULL)
  원인: e-gen 데이터 오염, 필드 매핑 오류
  대응:
    1. 동기화 전 스냅샷과 비교
    2. 이상 감지 → 롤백
    3. 관리자에게 수동 검토 요청
    4. 로그 저장 (분석용)
```

---

## 6. 성능 고려사항

### 6.1 처리량 및 시간

```
데이터:
  - 레코드 수: 81,464개
  - 평균 레코드 크기: ~2KB
  - 총 데이터: ~160MB

목표 시간:
  - 다운로드: < 5분 (네트워크 속도 32MB/s 기준)
  - 검증: < 5분
  - 데이터베이스 쓰기: < 10분
  - 전체 동기화 시간: < 30분

배치 윈도우:
  - 04:00~05:00 KST (1시간 버퍼)
  - 아침 07:00까지 완료 필수
  - 야간에 진행 (사용자 영향 없음)
```

### 6.2 데이터베이스 최적화

```
인덱스 생성 (동기화 전):
  - equipment_serial (UNIQUE, 기존)
  - updated_at (동기화 시간 필터링용)
  - jurisdiction_health_center (FK 검증용)

배치 쓰기 최적화:
  - COPY 또는 BULK INSERT 사용 (INSERT 반복 피함)
  - 배치 크기: 1000~5000 레코드
  - 트랜잭션: 단일 트랜잭션으로 atomic 보장

메모리 관리:
  - 스트리밍 처리 (모든 데이터를 메모리에 로드 X)
  - 청크 단위 처리 (1000개씩)
```

### 6.3 네트워크 최적화

```
압축:
  - gzip 압축 활용 (160MB → 20MB 예상)
  - 네트워크 시간: 5분 → 30초

재시도 전략:
  - 지수 백오프: 1초, 2초, 4초
  - 최대 재시도: 3회
  - 총 대기: ~7초
```

---

## 7. 모니터링 및 로깅

### 7.1 로깅 레벨

```
DEBUG:
  - 각 레코드 처리 로그
  - 필드 매핑 상세 정보
  - 데이터베이스 쿼리 (count: 이정도)

INFO (권장 레벨):
  - 동기화 시작/완료
  - 처리된 레코드 수 (삽입, 수정, 삭제)
  - 경과 시간
  - 에러 수 및 경고 수

WARN:
  - 유효성 검사 실패한 레코드 (몇 개)
  - 재시도 시작 (네트워크 오류)
  - 비정상적인 동기화 시간 (예: 예상 30분, 실제 60분)

ERROR:
  - e-gen API 연결 실패
  - 데이터베이스 쓰기 실패
  - 데이터 무결성 위반
```

### 7.2 메트릭 수집

```
Prometheus 메트릭 (권장):
  - edgen_sync_duration_seconds (히스토그램)
  - edgen_sync_records_total (카운터, 라벨: 상태)
  - edgen_sync_errors_total (카운터, 라벨: 에러 유형)
  - edgen_sync_last_success_timestamp (gauge)

대시보드:
  - 일일 동기화 성공 비율
  - 평균 처리 시간 추세
  - 에러 발생 패턴
```

### 7.3 알림 규칙

```
Critical:
  - 동기화 실패 3회 연속
  - 데이터 손상 감지
  - 처리 시간 > 1시간
  → 즉시 관리자에게 Slack 알림

Warning:
  - 에러 발생 (실패했지만 자동 복구 됨)
  - 처리 시간 > 45분
  → 일일 요약에 포함
```

---

## 8. 구현 계획

### 8.1 Phase별 구현

```
Phase A: 기본 동기화 (Week 1, Nov 24-28)
  □ e-gen API 클라이언트 작성
  □ 데이터 다운로드 + 파싱
  □ 형식 검증 로직
  □ 배치 INSERT 구현
  □ 로깅 추가

Phase B: 고급 기능 (Week 2, Dec 1-5)
  □ 증분 동기화 (changed_after 필터)
  □ 충돌 해결 (update vs insert)
  □ 롤백 로직
  □ 모니터링 메트릭

Phase C: 운영화 (Week 3, Dec 8-12)
  □ 배치 스케줄러 통합 (APScheduler)
  □ 에러 알림 (Slack)
  □ 대시보드 구축
  □ 문서화
```

### 8.2 테스트 전략

```
1. 단위 테스트
   - 필드 매핑 정확도
   - 유효성 검증 로직
   - 에러 핸들링

2. 통합 테스트
   - e-gen API 모킹
   - 실제 데이터베이스 동기화
   - 증분/전체 동기화 비교

3. 부하 테스트
   - 81K 레코드 처리 성능
   - 데이터베이스 잠금 없음 확인
   - 네트워크 대역폭 체크

4. 카나리 배포
   - 프로덕션 DB의 복사본에서 테스트
   - 실제 e-gen 데이터로 검증
   - 모니터링 메트릭 확인 후 프로덕션 적용
```

---

## 9. 리스크 및 완화 방안

| 리스크 | 확률 | 영향 | 완화 방안 |
|--------|------|------|----------|
| e-gen API 사양 변경 | Medium | High | 조기 협의 + 문서화 |
| 데이터 형식 오류 | Low | High | 엄격한 검증 로직 |
| 네트워크 중단 | Low | Medium | 재시도 + 폴백 |
| 데이터베이스 잠금 | Low | Medium | CONCURRENT INDEX, 배치 크기 조정 |
| 성능 저하 | Medium | Medium | 증분 동기화, 스트리밍 처리 |

---

## 10. 추가 조사 필요

```
협의 후 작성 예정:

1. e-gen API 상세 사양
   [ ] 엔드포인트 URL
   [ ] 인증 방식
   [ ] 요청/응답 형식
   [ ] 레이트 리미팅
   [ ] 오류 코드

2. 데이터 스키마 매핑
   [ ] e-gen 필드 목록
   [ ] 필드별 데이터 타입
   [ ] 필드별 길이 제한
   [ ] 선택적/필수 필드

3. 변경 추적 메커니즘
   [ ] 증분 동기화 지원?
   [ ] last_modified 필드?
   [ ] Webhook 지원?

4. 성능 특성
   [ ] 예상 QPS
   [ ] 최대 응답 시간
   [ ] 데이터 업데이트 빈도
```

---

**상태**: Draft (협의 대기)
**다음 단계**: e-gen 담당자와 협의 (Wed or Thu)
**협의자**: [기술 리더 이름]

