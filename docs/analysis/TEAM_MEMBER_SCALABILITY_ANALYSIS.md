# 팀원 시스템 확장성 분석 보고서

날짜: 2025-11-18
분석 대상: user_profiles 기반 팀원 필터링 시스템

## 1. 현황 요약

### 1.1 데이터 현황
- 전체 사용자: 54명
- 승인된 활성 사용자: 30명
- local_admin (보건소 담당자): 12명

### 1.2 역할별 분포
```
local_admin: 12명
temporary_inspector: 7명
emergency_center_admin: 5명
ministry_admin: 2명
regional_emergency_center_admin: 2명
regional_admin: 1명
master: 1명
```

### 1.3 보건소(local_admin) 지역별 분포
- 총 9개 지역에 분포
- **1명만 있는 지역: 7개** (팀원 없음 문제 발생)
  - DAE 수성구
  - JEJ 제주시
  - DAE 북구
  - DAE 서구
  - JEJ 서귀포시
  - GYN 김해시
  - SEJ null

- **2명 이상 있는 지역: 2개**
  - DAE null: 3명
  - DAE 중구: 2명

## 2. 현행 시스템 로직 분석

### 2.1 팀원 필터링 로직 (lib/utils/team-authorization.ts)

#### District 레벨 (local_admin)
```typescript
case 'district':
  return {
    ...baseFilter,
    region_code: currentUser.region_code,    // 동일 region_code 필수
    district: currentUser.district,          // 동일 district 필수
  };
```

**핵심 문제**: region_code AND district가 정확히 일치해야만 팀원으로 인식

### 2.2 일정 배정 시 팀원 조회
- API: `/api/team/members`
- 본인 제외: `id: { not: currentUser.id }`
- 활성 사용자만: `is_active: true`
- 승인된 사용자만: `approved_at: { not: null }`

## 3. 확장 시나리오별 분석

### 시나리오 1: 전체 보건소 1명씩 가입 (250명)

**예상 상황**:
- 250개 보건소 × 1명 = 250명 가입
- 각 보건소는 고유한 region_code + district 조합
- 결과: **250개 보건소 모두 "팀원 없음" 상태**

**문제점**:
- 일정 추가 시 항상 본인에게만 지정 가능
- 타 보건소 담당자와 협업 불가
- 시스템 본래 목적(팀원 협업) 달성 불가

### 시나리오 2: 일부 보건소 복수 인원 (현실적 시나리오)

**예상 분포**:
- 대형 보건소(인구 50만 이상): 2-3명
- 중형 보건소(인구 10-50만): 1-2명
- 소형 보건소(인구 10만 미만): 1명

**예시 (250개 보건소 기준)**:
- 50개 보건소: 3명씩 = 150명
- 50개 보건소: 2명씩 = 100명
- 150개 보건소: 1명씩 = 150명
- 총 400명

**결과**:
- 팀원 있는 보건소: 100개 (40%)
- 팀원 없는 보건소: 150개 (60%)

**문제점 지속**:
- 과반수 보건소가 여전히 "팀원 없음" 문제
- 소형 보건소일수록 불리
- 지역 격차 심화

### 시나리오 3: 최대 확장 (모든 보건소 3명)

**예상 상황**:
- 250개 보건소 × 3명 = 750명
- 각 보건소 내부 팀원 2명씩 보유

**장점**:
- 보건소 내부 협업 가능
- 일정 배정 시 선택지 존재

**여전히 남는 문제**:
- **타 보건소와 협업 불가**
- 인접 보건소 간 업무 분담 불가
- 지역 전체 통합 관리 어려움

## 4. 현행 로직의 구조적 한계

### 4.1 과도하게 엄격한 필터링
```typescript
// 현행: region_code AND district 모두 일치 필수
region_code: currentUser.region_code,
district: currentUser.district,

// 문제: 김해시 보건소 vs 창원시 보건소 = 완전 분리
// 같은 경남이지만 팀원으로 인식 불가
```

### 4.2 보건소 특성 미반영
- 보건소는 법적으로 독립적이지만 실무상 협업 필요
- 인접 지역 AED 점검 시 상호 지원
- 인력 부족 시 타 보건소 임시 점검자 지원

### 4.3 organization_id 미활용
- organizations 테이블 존재하지만 팀원 필터링에 미사용
- 조직 계층 구조 활용 불가
- 유연한 팀 구성 불가

## 5. 개선 방안

### 방안 1: 필터링 조건 완화 (가장 현실적)

**제안**: region_code만 일치하면 팀원으로 인식

```typescript
// 개선안 1: 같은 시도 내 모든 보건소 = 팀원
case 'district':
  return {
    ...baseFilter,
    region_code: currentUser.region_code,  // district 조건 제거
  };
```

**장점**:
- 코드 수정 최소 (1줄 삭제)
- 즉시 적용 가능
- 지역 내 협업 가능

**단점**:
- 경기도처럼 보건소가 많은 지역은 팀원 목록 과다

**영향 분석**:
- GYN (경남) 보건소: 김해시, 창원시, 거제시 등 모두 팀원
- DAE (대구) 보건소: 중구, 북구, 서구, 수성구 등 모두 팀원
- 현행 12명 → 각 지역별 합산

### 방안 2: 선택적 팀원 추가 (team_members 활용)

**제안**: 기본은 같은 district, 수동으로 타 지역 팀원 추가

```typescript
// team_members 테이블 재활용
// user_profile_id 연결하여 임시 팀원 지정
```

**장점**:
- 유연한 팀 구성
- 필요시에만 확장
- 기존 테이블 재활용

**단점**:
- 관리 복잡도 증가
- 팀원 추가/제거 UI 필요
- 데이터 정합성 관리 필요

### 방안 3: 3단계 팀원 구조

**제안**: 핵심 팀원 / 지역 팀원 / 전체 팀원

```typescript
const teamFilter = {
  OR: [
    // 1단계: 같은 district (핵심 팀원)
    {
      region_code: currentUser.region_code,
      district: currentUser.district,
    },
    // 2단계: 같은 region_code (지역 팀원)
    {
      region_code: currentUser.region_code,
      role: 'local_admin',
    },
    // 3단계: team_members 테이블에 추가된 팀원
    {
      id: { in: manuallyAddedTeamMemberIds }
    }
  ]
};
```

**장점**:
- 단계별 구분으로 명확성 확보
- 유연성과 구조 모두 충족
- 점진적 확장 가능

**단점**:
- 구현 복잡도 높음
- UI 개선 필요
- 성능 고려 필요

## 6. 권장 사항

### 즉시 적용 (Phase 1)
**방안 1 채택: district 조건 제거**

**이유**:
1. 코드 수정 최소 (1줄)
2. 즉시 효과 확인 가능
3. 현재 가입자 소수일 때 테스트 적기
4. 추후 롤백 용이

**예상 효과**:
- DAE 지역: 6명 → 서로 팀원
- GYN 김해시: 1명 → 경남 내 다른 보건소와 협업 가능
- JEJ 지역: 2명 → 제주시/서귀포시 협업 가능

### 중기 개선 (Phase 2)
**UI 개선**

1. 팀원 목록에 소속 표시
   ```
   팀원 선택:
   ☐ 김철수 (대구 중구 보건소) - 핵심 팀원
   ☐ 이영희 (대구 북구 보건소) - 지역 팀원
   ```

2. 필터링 옵션 추가
   ```
   팀원 범위:
   ○ 우리 보건소만
   ● 대구 전체
   ○ 전국 (master만)
   ```

### 장기 계획 (Phase 3)
**방안 3 도입**

- team_members 테이블 재설계
- 조직 계층 구조 활용
- 복잡한 협업 구조 지원

## 7. 결론

### 현행 시스템 평가
- ✅ 소규모(30명)에서 작동
- ⚠️ 확장 시 한계 명확
- ❌ 보건소 특성 미반영

### 확장성 평가
- **시나리오 1 (250명)**: ❌ 불가능 (모두 팀원 없음)
- **시나리오 2 (400명)**: ⚠️ 제한적 (60%가 팀원 없음)
- **시나리오 3 (750명)**: △ 부분적 (보건소 내부만 가능)

### 최종 권장 사항
1. **즉시**: district 조건 제거 (방안 1)
2. **2주 후**: 효과 분석 및 피드백 수집
3. **1개월 후**: UI 개선 (방안 2 또는 3 선택)
4. **3개월 후**: 장기 계획 수립

---

**다음 단계**:
1. [ ] 방안 1 코드 수정 (lib/utils/team-authorization.ts:85)
2. [ ] 로컬 테스트
3. [ ] 프로덕션 배포
4. [ ] 사용자 피드백 수집
5. [ ] Phase 2 기획
