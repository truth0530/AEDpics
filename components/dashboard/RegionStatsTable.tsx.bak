'use client';

import { useState, useMemo } from 'react';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Search, ArrowUpDown, Download } from 'lucide-react';

interface RegionStats {
  region: string;
  total: number;
  mandatory: number;
  nonMandatory: number;
  completed: number;
  completedMandatory: number;
  completedNonMandatory: number;
  assigned: number;
  assignedMandatory: number;
  assignedNonMandatory: number;
  fieldInspected: number;
  fieldInspectedMandatory: number;
  fieldInspectedNonMandatory: number;
  rate: number;
}

interface RegionStatsTableProps {
  data: RegionStats[];
  onRegionClick: (region: RegionStats) => void;
}

type SortField = 'region' | 'total' | 'rate' | 'assigned' | 'fieldInspected';
type SortDirection = 'asc' | 'desc';

export default function RegionStatsTable({ data, onRegionClick }: RegionStatsTableProps) {
  const [searchTerm, setSearchTerm] = useState('');
  const [sortField, setSortField] = useState<SortField>('total');
  const [sortDirection, setSortDirection] = useState<SortDirection>('desc');

  // ê²€ìƒ‰ ë° ì •ë ¬
  const filteredAndSortedData = useMemo(() => {
    let filtered = data.filter((region) =>
      region.region.toLowerCase().includes(searchTerm.toLowerCase())
    );

    filtered.sort((a, b) => {
      let comparison = 0;
      switch (sortField) {
        case 'region':
          comparison = a.region.localeCompare(b.region, 'ko-KR');
          break;
        case 'total':
          comparison = a.total - b.total;
          break;
        case 'rate':
          comparison = a.rate - b.rate;
          break;
        case 'assigned':
          comparison = a.assigned - b.assigned;
          break;
        case 'fieldInspected':
          comparison = a.fieldInspected - b.fieldInspected;
          break;
      }
      return sortDirection === 'asc' ? comparison : -comparison;
    });

    return filtered;
  }, [data, searchTerm, sortField, sortDirection]);

  const handleSort = (field: SortField) => {
    if (sortField === field) {
      setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
    } else {
      setSortField(field);
      setSortDirection('desc');
    }
  };

  const getStatusColor = (rate: number) => {
    if (rate >= 80) return 'text-green-400';
    if (rate >= 60) return 'text-yellow-400';
    return 'text-red-400';
  };

  const getStatusIndicator = (rate: number) => {
    if (rate >= 80) return 'ğŸŸ¢';
    if (rate >= 60) return 'ğŸŸ¡';
    return 'ğŸ”´';
  };

  const formatNumber = (num: number) => {
    if (num >= 1000) {
      return `${(num / 1000).toFixed(1)}K`;
    }
    return num.toString();
  };

  const handleDownloadCSV = () => {
    const headers = ['ì§€ì—­', 'ì „ì²´', 'ê´€ë¦¬ìì ê²€ìœ¨', 'ì¼ì •ì¶”ê°€', 'í˜„ì¥ì ê²€'];
    const rows = filteredAndSortedData.map((region) => [
      region.region,
      region.total,
      `${region.rate}%`,
      region.assigned,
      region.fieldInspected,
    ]);

    const csvContent = [
      headers.join(','),
      ...rows.map((row) => row.join(',')),
    ].join('\n');

    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `ì‹œë„ë³„_í†µê³„_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
  };

  return (
    <div className="space-y-4">
      {/* ê²€ìƒ‰ ë° í•„í„° ë°” */}
      <div className="flex items-center gap-4 flex-wrap">
        <div className="relative flex-1 min-w-[200px]">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
          <Input
            type="text"
            placeholder="ì§€ì—­ ê²€ìƒ‰..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="pl-10 bg-gray-900 border-gray-800 text-white"
          />
        </div>
        <Button
          variant="outline"
          size="sm"
          onClick={handleDownloadCSV}
          className="bg-gray-900 border-gray-800 text-gray-300 hover:bg-gray-800"
        >
          <Download className="h-4 w-4 mr-2" />
          CSV ë‹¤ìš´ë¡œë“œ
        </Button>
      </div>

      {/* í†µê³„ ìš”ì•½ */}
      <div className="text-sm text-gray-400">
        ì´ {filteredAndSortedData.length}ê°œ ì§€ì—­ í‘œì‹œ
      </div>

      {/* í…Œì´ë¸” */}
      <div className="bg-gray-900 border border-gray-800 rounded-lg overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="bg-gray-800/50">
              <tr>
                <th className="px-4 py-3 text-left">
                  <button
                    onClick={() => handleSort('region')}
                    className="flex items-center gap-1 text-xs font-medium text-gray-300 hover:text-white"
                  >
                    ì§€ì—­
                    <ArrowUpDown className="h-3 w-3" />
                  </button>
                </th>
                <th className="px-4 py-3 text-right">
                  <button
                    onClick={() => handleSort('total')}
                    className="flex items-center gap-1 ml-auto text-xs font-medium text-gray-300 hover:text-white"
                  >
                    ì „ì²´
                    <ArrowUpDown className="h-3 w-3" />
                  </button>
                </th>
                <th className="px-4 py-3 text-right">
                  <button
                    onClick={() => handleSort('rate')}
                    className="flex items-center gap-1 ml-auto text-xs font-medium text-gray-300 hover:text-white"
                  >
                    ê´€ì ë¥ 
                    <ArrowUpDown className="h-3 w-3" />
                  </button>
                </th>
                <th className="px-4 py-3 text-right">
                  <button
                    onClick={() => handleSort('assigned')}
                    className="flex items-center gap-1 ml-auto text-xs font-medium text-gray-300 hover:text-white"
                  >
                    ì¼ì •ì¶”ê°€
                    <ArrowUpDown className="h-3 w-3" />
                  </button>
                </th>
                <th className="px-4 py-3 text-right">
                  <button
                    onClick={() => handleSort('fieldInspected')}
                    className="flex items-center gap-1 ml-auto text-xs font-medium text-gray-300 hover:text-white"
                  >
                    í˜„ì¥ì ê²€
                    <ArrowUpDown className="h-3 w-3" />
                  </button>
                </th>
                <th className="px-4 py-3 text-center">
                  <span className="text-xs font-medium text-gray-300">ì§„ì²™ë¥ </span>
                </th>
                <th className="px-4 py-3 text-center">
                  <span className="text-xs font-medium text-gray-300">ìƒì„¸</span>
                </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-800">
              {filteredAndSortedData.map((region) => (
                <tr
                  key={region.region}
                  className="hover:bg-gray-800/50 transition-colors"
                >
                  <td className="px-4 py-3">
                    <div className="flex items-center gap-2">
                      <span className="text-lg">{getStatusIndicator(region.rate)}</span>
                      <span className="text-sm font-medium text-white">
                        {region.region}
                      </span>
                    </div>
                  </td>
                  <td className="px-4 py-3 text-right">
                    <span className="text-sm text-gray-300">
                      {formatNumber(region.total)}
                    </span>
                  </td>
                  <td className="px-4 py-3 text-right">
                    <span className={`text-sm font-semibold ${getStatusColor(region.rate)}`}>
                      {region.rate.toFixed(1)}%
                    </span>
                  </td>
                  <td className="px-4 py-3 text-right">
                    <span className="text-sm text-orange-400">
                      {region.assigned}
                    </span>
                  </td>
                  <td className="px-4 py-3 text-right">
                    <span className="text-sm text-green-400">
                      {region.fieldInspected}
                    </span>
                  </td>
                  <td className="px-4 py-3">
                    <div className="flex items-center justify-center gap-2">
                      <div className="w-16 bg-gray-800 rounded-full h-2">
                        <div
                          className={`h-2 rounded-full ${
                            region.rate >= 80
                              ? 'bg-green-500'
                              : region.rate >= 60
                              ? 'bg-yellow-500'
                              : 'bg-red-500'
                          }`}
                          style={{ width: `${Math.min(region.rate, 100)}%` }}
                        />
                      </div>
                    </div>
                  </td>
                  <td className="px-4 py-3 text-center">
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => onRegionClick(region)}
                      className="text-blue-400 hover:text-blue-300 hover:bg-gray-800"
                    >
                      ë³´ê¸°
                    </Button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {/* ë¹ˆ ê²°ê³¼ ë©”ì‹œì§€ */}
      {filteredAndSortedData.length === 0 && (
        <div className="text-center py-8 text-gray-400">
          ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
      )}
    </div>
  );
}
