# PostgreSQL í•¨ìˆ˜ ì‘ì„± ê°€ì´ë“œ

## âš ï¸ ìµœìš°ì„  í™•ì¸ì‚¬í•­ (2025-10-04 ì—…ë°ì´íŠ¸)

### ì‹¤ì œ ìŠ¤í‚¤ë§ˆ í•„ìˆ˜ í™•ì¸
**í•¨ìˆ˜ ì‘ì„± ì „ ë°˜ë“œì‹œ ì½ì„ ë¬¸ì„œ**:
- `/supabase/ACTUAL_SCHEMA_REFERENCE.md` - ì‹¤ì œ DB ìŠ¤í‚¤ë§ˆ
- `/supabase/migrations/00_MIGRATION_WARNING.md` - ê²½ê³  ë° ê¸ˆì§€ ì»¬ëŸ¼
- `/supabase/COMPLETE_MIGRATION_GUIDE.md` - ì‘ì„± ê°€ì´ë“œ

### ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€ ì»¬ëŸ¼
```
âŒ health_center_id      (ì‹¤ì œ: jurisdiction_health_center VARCHAR)
âŒ region_code           (ì‹¤ì œ: sido VARCHAR)
âŒ city_code             (ì‹¤ì œ: gugun VARCHAR)
âŒ device_serial         (ì‹¤ì œ: equipment_serial VARCHAR)
âŒ device_serial_number  (ì‹¤ì œ: serial_number VARCHAR)
âŒ institution_name      (ì‹¤ì œ: installation_institution VARCHAR)
âŒ category              (ì‹¤ì œ: category_1, category_2, category_3 VARCHAR)
```

---

## ì¤‘ìš”: íƒ€ì… ìºìŠ¤íŒ… ê·œì¹™

### ë¬¸ì œ ì‚¬ë¡€
ì§€ë„ ê¸°ëŠ¥ ì¶”ê°€ ì¤‘ `get_aed_data_filtered` í•¨ìˆ˜ì—ì„œ ë°˜ë³µì ìœ¼ë¡œ ë°œìƒí•œ íƒ€ì… ë¶ˆì¼ì¹˜ ì—ëŸ¬:
```
ERROR: 42804: structure of query does not match function result type
DETAIL: Returned type character varying(255) does not match expected type text in column 2.
```

### ì›ì¸
PostgreSQLì˜ `RETURNS TABLE`ì—ì„œ ì •ì˜í•œ íƒ€ì…ê³¼ ì‹¤ì œ SELECT ê²°ê³¼ì˜ íƒ€ì…ì´ ì •í™•íˆ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ì—ëŸ¬ ë°œìƒ.
- `aed_data` í…Œì´ë¸”ì˜ ë§ì€ ì»¬ëŸ¼ì´ `character varying(255)` íƒ€ì…
- í•¨ìˆ˜ì—ì„œëŠ” `TEXT` íƒ€ì…ìœ¼ë¡œ ë°˜í™˜í•˜ë ¤ê³  í–ˆìœ¼ë‚˜ ì•”ë¬µì  ë³€í™˜ì´ ë˜ì§€ ì•ŠìŒ

### í•´ê²° ë°©ë²•

#### âŒ ì˜ëª»ëœ ë°©ë²•
```sql
RETURNS TABLE (
  device_serial TEXT,
  management_number TEXT,
  ...
)
...
SELECT
  ad.equipment_serial AS device_serial,  -- VARCHAR(255) â†’ TEXT ì•”ë¬µì  ë³€í™˜ ì‹¤íŒ¨
  ad.management_number,                  -- VARCHAR(255) â†’ TEXT ì•”ë¬µì  ë³€í™˜ ì‹¤íŒ¨
```

#### âœ… ì˜¬ë°”ë¥¸ ë°©ë²•
```sql
RETURNS TABLE (
  equipment_serial TEXT,  -- âš ï¸ ì‹¤ì œ ì»¬ëŸ¼ëª… ì‚¬ìš©!
  management_number TEXT,
  ...
)
...
SELECT
  ad.equipment_serial::TEXT,         -- ëª…ì‹œì  ìºìŠ¤íŒ…
  ad.management_number::TEXT,        -- ëª…ì‹œì  ìºìŠ¤íŒ…
```

---

## í•„ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸

### 1. íƒ€ì… í™•ì¸
í•¨ìˆ˜ ì‘ì„± ì „ì— ë°˜ë“œì‹œ ì‹¤ì œ í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ í™•ì¸:
```sql
SELECT column_name, data_type, character_maximum_length
FROM information_schema.columns
WHERE table_name = 'aed_data'
ORDER BY ordinal_position;
```

### 2. VARCHAR í•„ë“œ ì²˜ë¦¬
`aed_data` í…Œì´ë¸”ì˜ VARCHAR í•„ë“œë“¤ (ëª¨ë‘ `::TEXT` ìºìŠ¤íŒ… í•„ìš”):
- `equipment_serial` - character varying(255)
- `management_number` - character varying(255)
- `installation_institution` - character varying(255) âš ï¸ **NOT institution_name**
- `installation_address` - character varying(255)
- `installation_position` - character varying(255)
- `jurisdiction_health_center` - character varying(255) âš ï¸ **NOT health_center_id**
- `institution_contact` - character varying(255)
- `sido` - character varying(255) âš ï¸ **NOT region_code**
- `gugun` - character varying(255) âš ï¸ **NOT city_code**
- `category_1`, `category_2`, `category_3` - character varying(255) âš ï¸ **NOT category**

### 3. COALESCE ê²°ê³¼ë„ ìºìŠ¤íŒ…
COALESCEë‚˜ CASE ë¬¸ì˜ ê²°ê³¼ë„ ëª…ì‹œì ìœ¼ë¡œ ìºìŠ¤íŒ…:
```sql
-- âŒ ì˜ëª»ëœ ì˜ˆ
COALESCE(hc.region_code, ad.sido) AS region_code  -- region_code ì»¬ëŸ¼ ì¡´ì¬ ì•ˆí•¨!

-- âœ… ì˜¬ë°”ë¥¸ ì˜ˆ
ad.sido::TEXT AS sido  -- ì‹¤ì œ ì»¬ëŸ¼ëª… ì‚¬ìš©
```

### 4. í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ì‘ì„± í›„ ë°˜ë“œì‹œ ì§ì ‘ ì‹¤í–‰ í…ŒìŠ¤íŠ¸:
```sql
-- ì‹¤ì œ í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸
SELECT * FROM get_aed_data_filtered('master', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 1, 0);
```

### 5. ìŠ¤í‚¤ë§ˆ ìºì‹œ ê°±ì‹ 
Supabaseì—ì„œ í•¨ìˆ˜ ë³€ê²½ í›„ ë°˜ë“œì‹œ ì‹¤í–‰:
```sql
NOTIFY pgrst, 'reload schema';
```

---

## ë§ˆì´ê·¸ë ˆì´ì…˜ ì´ë ¥

### ì‹¤íŒ¨ ì‚¬ë¡€ (30-39ë²ˆ)
- **30-39ë²ˆ**: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì»¬ëŸ¼ ì°¸ì¡° (`health_center_id`, `region_code` ë“±)
- **êµí›ˆ**: ì ˆëŒ€ ì¶”ì¸¡í•˜ì§€ ë§ ê²ƒ, ë°˜ë“œì‹œ ì‹¤ì œ ìŠ¤í‚¤ë§ˆ í™•ì¸

### ì„±ê³µ ì‚¬ë¡€
- **40ë²ˆ** â­: `40_fix_varchar_text_mismatch.sql` - ìµœì¢… ì„±ê³µ ë²„ì „
  - âœ… VARCHAR â†’ TEXT ëª…ì‹œì  ìºìŠ¤íŒ…
  - âœ… ì‹¤ì œ ì»¬ëŸ¼ëª… ì‚¬ìš© (`equipment_serial`, `sido`, `gugun`)
  - âœ… ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì»¬ëŸ¼ ì™„ì „ ì œê±°

### 2025-10-04 ì‹ ê·œ: êµ¬ë¹„ì˜ë¬´ê¸°ê´€ ë§¤ì¹­ ì‹œìŠ¤í…œ (41-46ë²ˆ)
- **41ë²ˆ**: `target_list_2024` í…Œì´ë¸” ìƒì„±
- **42ë²ˆ**: `target_key` ìë™ ìƒì„±
- **43ë²ˆ**: `aed_target_mapping` ì˜ì†ì„± ë§¤í•‘
- **44ë²ˆ**: ì¥ë¹„ì—°ë²ˆ ê¸°ë°˜ ìë™ ë§¤ì¹­
- **45ë²ˆ**: 1:N ë§¤í•‘ ì§€ì› (`management_number_group_mapping`)
- **46ë²ˆ**: ê´€ë¦¬ë²ˆí˜¸ ê¸°ë°˜ ê·¸ë£¹ ë§¤ì¹­

---

## êµí›ˆ

1. **PostgreSQLì€ íƒ€ì…ì— ë§¤ìš° ì—„ê²©í•¨** - TEXTì™€ VARCHARëŠ” ì•”ë¬µì  ë³€í™˜ì´ ì•ˆ ë  ìˆ˜ ìˆìŒ
2. **ëª…ì‹œì  ìºìŠ¤íŒ…ì´ í•­ìƒ ì•ˆì „í•¨** - ì˜ì‹¬ìŠ¤ëŸ¬ìš°ë©´ `::TEXT` ì¶”ê°€
3. **í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ì™€ êµ¬í˜„ì²´ì˜ ì™„ë²½í•œ ì¼ì¹˜** - RETURNS TABLEê³¼ SELECT ê²°ê³¼ íƒ€ì…ì´ ì •í™•íˆ ë™ì¼í•´ì•¼ í•¨
4. **í…ŒìŠ¤íŠ¸ëŠ” ì‹¤ì œ ë°ì´í„°ë¡œ** - ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ í›„ ë°˜ë“œì‹œ SELECT í…ŒìŠ¤íŠ¸
5. **ì›ë³¸ ì‘ë™ ì½”ë“œë¥¼ ì°¸ê³ í•˜ë˜, ë§¹ëª©ì ìœ¼ë¡œ ë”°ë¼í•˜ì§€ ë§ ê²ƒ** - 09ë²ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ë„ ìºìŠ¤íŒ…ì´ í•„ìš”í–ˆìŒ
6. **ì ˆëŒ€ ì»¬ëŸ¼ëª…ì„ ì¶”ì¸¡í•˜ì§€ ë§ ê²ƒ** - `information_schema.columns` í•„ìˆ˜ í™•ì¸ â­
7. **40ë²ˆ ì´í›„ ì‹œí–‰ì°©ì˜¤ ë** - 40ë²ˆì„ ê¸°ì¤€ìœ¼ë¡œ ì‚¼ì„ ê²ƒ

---

## ì°¸ê³ : ë‹¤ë¥¸ ì¼ë°˜ì ì¸ íƒ€ì… ë³€í™˜

```sql
-- ìˆ«ì íƒ€ì…
some_numeric_field::INTEGER
some_float_field::NUMERIC
some_id::BIGINT

-- ë‚ ì§œ/ì‹œê°„
some_timestamp::DATE
some_date::TIMESTAMP

-- ë¶ˆë¦°
some_boolean::BOOLEAN

-- UUID
some_uuid_field::UUID

-- JSON
some_json_field::JSONB
some_text::JSON
```

---

## ë””ë²„ê¹… íŒ

### ì—ëŸ¬ ë©”ì‹œì§€ ì½ê¸°
```
DETAIL: Returned type character varying(255) does not match expected type text in column 2.
```
- **column 2**: RETURNS TABLEì˜ ë‘ ë²ˆì§¸ ì»¬ëŸ¼ (0ë¶€í„° ì‹œì‘ ì•„ë‹˜, 1ë¶€í„° ì‹œì‘)
- í•´ë‹¹ ì»¬ëŸ¼ì´ ë¬´ì—‡ì¸ì§€ í™•ì¸í•˜ê³  SELECT ë¬¸ì—ì„œ í•´ë‹¹ í•„ë“œ ì°¾ê¸°

### ì»¬ëŸ¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
```sql
-- íŠ¹ì • ì»¬ëŸ¼ ì¡´ì¬ í™•ì¸
SELECT column_name
FROM information_schema.columns
WHERE table_name = 'aed_data'
  AND column_name IN ('category', 'institution_name', 'region_code');
-- ê²°ê³¼ê°€ 0ê±´ì´ë©´ ì»¬ëŸ¼ì´ ì—†ëŠ” ê²ƒ!
```

### í•¨ìˆ˜ ì •ì˜ í™•ì¸
```sql
-- í˜„ì¬ í•¨ìˆ˜ ì •ì˜ ë³´ê¸°
\df+ get_aed_data_filtered

-- ë˜ëŠ”
SELECT proname, prosrc
FROM pg_proc
WHERE proname = 'get_aed_data_filtered';
```

### Supabase PostgREST ìºì‹œ ë¬¸ì œ
í•¨ìˆ˜ë¥¼ ìˆ˜ì •í–ˆëŠ”ë°ë„ ì—ëŸ¬ê°€ ê³„ì†ë˜ë©´:
1. `NOTIFY pgrst, 'reload schema';` ì‹¤í–‰
2. Supabase í”„ë¡œì íŠ¸ ì¬ì‹œì‘ (Dashboard > Settings > Restart)
3. ê°œë°œ ì„œë²„ ì¬ì‹œì‘ (`npm run dev` ì¢…ë£Œ í›„ ì¬ì‹¤í–‰)

---

## ğŸ“š í•„ìˆ˜ ì°¸ì¡° ë¬¸ì„œ

1. **`/supabase/ACTUAL_SCHEMA_REFERENCE.md`** - ì‹¤ì œ ìŠ¤í‚¤ë§ˆ ì •ì˜
2. **`/supabase/migrations/00_MIGRATION_WARNING.md`** - ê²½ê³  ë° ê¸ˆì§€ ì»¬ëŸ¼
3. **`/supabase/COMPLETE_MIGRATION_GUIDE.md`** - ìƒì„¸ ê°€ì´ë“œ
4. **`/supabase/migrations/README_CLEANED.md`** - ì •ë¦¬ëœ Migration ëª©ë¡
5. **`/supabase/migrations/MIGRATION_AUDIT_REPORT.md`** - ê°ì‚¬ ë³´ê³ ì„œ

---

**ìµœì¢… ì—…ë°ì´íŠ¸: 2025-10-04**
