# ì •ë¦¬ëœ Migration íŒŒì¼ ëª©ë¡

## ğŸ“… ì •ë¦¬ ì¼ì: 2025-10-04 (ìµœì¢… ì—…ë°ì´íŠ¸)

## ğŸ¯ í˜„ì¬ ìƒíƒœ
- **ì´ Migration íŒŒì¼**: 31ê°œ
- **ë³´ê´€ëœ íŒŒì¼**: 19ê°œ (_archive_failed_attempts/)
- **í•µì‹¬ RPC í•¨ìˆ˜**: 40_fix_varchar_text_mismatch.sql
- **ì‹ ê·œ ì¶”ê°€ (2025-10-04)**: 41-47ë²ˆ êµ¬ë¹„ì˜ë¬´ê¸°ê´€ ë§¤ì¹­ ì‹œìŠ¤í…œ

---

## âœ… í˜„ì¬ ìœ ì§€ ì¤‘ì¸ Migration (31ê°œ)

### ê¸°ë³¸ ìŠ¤í‚¤ë§ˆ (01-06)
1. `01_initial_schema.sql` - ê¸°ë³¸ í…Œì´ë¸” (organizations, user_profiles)
2. `02_initial_data.sql` - ì´ˆê¸° ë°ì´í„°
3. `03_rls_policies.sql` - Row Level Security ì •ì±…
4. `04_aed_tables.sql` - AED ë°ì´í„° í…Œì´ë¸”
5. `05_team_management.sql` - íŒ€ ê´€ë¦¬ ê¸°ëŠ¥
6. `06_fix_inspection_schema.sql` - ì ê²€ ìŠ¤í‚¤ë§ˆ ìˆ˜ì •

### í•µì‹¬ ê¸°ëŠ¥ (10-20)
7. `10_aed_data_rls_policy.sql` - AED ë°ì´í„° RLS ì •ì±…
8. `11_create_notifications.sql` - ì•Œë¦¼ í…Œì´ë¸” ìƒì„±
9. `12_fix_notification_policies.sql` - ì•Œë¦¼ ì •ì±… ìˆ˜ì •
10. `13_add_last_login.sql` - ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì¶”ì 
11. `14_login_tracking.sql` - ë¡œê·¸ì¸ ì´ë ¥ ì¶”ì 
12. `15_organization_changes.sql` - ì¡°ì§ êµ¬ì¡° ë³€ê²½
13. `16_inspection_schedule_entries.sql` - ì ê²€ ìŠ¤ì¼€ì¤„ ê´€ë¦¬
14. `17_duplicate_equipment_handling.sql` - ì¤‘ë³µ ì¥ë¹„ ì²˜ë¦¬
15. `18_notification_system.sql` - ì•Œë¦¼ ì‹œìŠ¤í…œ ê°œì„ 
16. `19_gps_issues_table.sql` - GPS ì´ìŠˆ ì¶”ì 
17. `20_create_inspection_sessions.sql` - ì ê²€ ì„¸ì…˜ ê´€ë¦¬

### ì¶”ê°€ ê¸°ëŠ¥ (25-31)
18. `25_otp_rate_limiting.sql` - OTP ìš”ì²­ ì œí•œ
19. `28_add_field_changes_to_sessions.sql` - í•„ë“œ ë³€ê²½ ì¶”ì 
20. `31_add_coordinates_to_organizations.sql` - ì¡°ì§ ì¢Œí‘œ ì¶”ê°€

### 2025ë…„ 9ì›” ì¶”ê°€ ê¸°ëŠ¥
21. `20250927_create_missing_tables.sql` - ëˆ„ë½ í…Œì´ë¸” ìƒì„± (2025ë…„ 9ì›”)
22. `20250927_create_audit_logs.sql` - ê°ì‚¬ ë¡œê·¸ í…Œì´ë¸” (2025ë…„ 9ì›”)
23. `20250927_safe_audit_logs_setup.sql` - ì•ˆì „í•œ ê°ì‚¬ ë¡œê·¸ ì„¤ì • (2025ë…„ 9ì›”)

### â­ ìµœì¢… RPC í•¨ìˆ˜
24. **`40_fix_varchar_text_mismatch.sql`** - get_aed_data_filtered ìµœì¢… ì„±ê³µ ë²„ì „
    - âœ… VARCHAR íƒ€ì… ì •í™•íˆ ë§¤ì¹­
    - âœ… ì‹¤ì œ ìŠ¤í‚¤ë§ˆ ê¸°ë°˜
    - âœ… ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì»¬ëŸ¼ ì œê±° ì™„ë£Œ

### ğŸ†• 2025-10-04 ì‹ ê·œ: êµ¬ë¹„ì˜ë¬´ê¸°ê´€ ë§¤ì¹­ ì‹œìŠ¤í…œ (41-46)
25. **`41_target_list_2024_upload.sql`** - êµ¬ë¹„ì˜ë¬´ê¸°ê´€ ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” ìƒì„±
    - target_list_2024 í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ì •ì˜
    - 26,724ê°œ ê¸°ê´€ ë°ì´í„° êµ¬ì¡°

26. **`42_target_key_generation.sql`** - target_key ìë™ ìƒì„±
    - ROW_NUMBER() OVER (PARTITION BY target_keygroup)
    - ê³ ìœ  ì‹ë³„ì ìë™ ìƒì„±

27. **`43_aed_target_mapping.sql`** - AED â†” êµ¬ë¹„ì˜ë¬´ê¸°ê´€ ì˜ì†ì„± ë§¤í•‘
    - equipment_serial ê¸°ë°˜ ë§¤í•‘
    - 2024/2025 ë“€ì–¼ ì§€ì›
    - ìë™ ì¶”ì²œ + ë‹´ë‹¹ì í™•ì • ì›Œí¬í”Œë¡œìš°

28. **`44_auto_matching_function.sql`** - ì¥ë¹„ì—°ë²ˆ ê¸°ë°˜ ìë™ ë§¤ì¹­
    - normalize_text(), simple_similarity() í•¨ìˆ˜
    - auto_match_single_aed()
    - auto_match_batch()
    - confirm_target_match(), modify_target_match()

29. **`45_fix_one_to_many_mapping.sql`** - 1:N ë§¤í•‘ ì§€ì›
    - management_number_group_mapping í…Œì´ë¸” ìƒì„±
    - 1ê°œ ê¸°ê´€ â†’ ì—¬ëŸ¬ ê´€ë¦¬ë²ˆí˜¸ ì§€ì›
    - aed_with_target_2024 ë·° ì—…ë°ì´íŠ¸
    - target_management_number_groups ë·°

30. **`46_auto_match_management_number.sql`** - ê´€ë¦¬ë²ˆí˜¸ ê¸°ë°˜ ê·¸ë£¹ ë§¤ì¹­
    - auto_match_single_management_number()
    - auto_match_management_numbers_batch()
    - confirm_management_number_match()
    - modify_management_number_match()
    - get_sample_management_numbers()

31. **`47_target_matching_ui_functions.sql`** - ë§¤ì¹­ ê´€ë¦¬ UI ì§€ì› í•¨ìˆ˜
    - get_target_matching_list_2024() - UIìš© ë§¤ì¹­ ëª©ë¡ ì¡°íšŒ
    - ì‹ ë¢°ë„ë³„ í•„í„°ë§ (high/medium/low/all)
    - ì§€ì—­/ê²€ìƒ‰/í™•ì • ì—¬ë¶€ í•„í„° ì§€ì›

---

## ğŸ—‘ï¸ ë³´ê´€ëœ íŒŒì¼ (_archive_failed_attempts/)

### ì‹¤íŒ¨í•œ RPC í•¨ìˆ˜ ì‹œë„ (30-39)
- 30-35, 36-39: ì˜ëª»ëœ ìŠ¤í‚¤ë§ˆ ì°¸ì¡°ë¡œ ì‹¤íŒ¨

### ì˜ëª»ëœ ìŠ¤í‚¤ë§ˆ ì°¸ì¡° íŒŒì¼
- 07_health_center_mapping.sql
- 08_health_center_initial_data.sql
- 09_aed_query_functions.sql
- 23_aed_query_functions_complete.sql

### region_code ê´€ë ¨ ì‹¤íŒ¨ ì‹œë„
- 26_region_code_migration.sql
- 26_region_code_migration_rollback.sql
- 27_persistent_mapping_table.sql

### ì„ì‹œ ì‹¤í–‰ íŒŒì¼
- APPLY_PENDING_MIGRATIONS.sql
- ESSENTIAL_MIGRATIONS_2025_10_04_v3.sql (âš ï¸ í˜¼ë€ì˜ ê·¼ì›)
- RUN_THIS_FOR_AED_MAP.sql

---

## ğŸ“‹ Migration ì‹¤í–‰ ìˆœì„œ

í”„ë¡œë•ì…˜ DBì— ìƒˆë¡œ ì ìš© ì‹œ:
```
01 â†’ 02 â†’ 03 â†’ 04 â†’ 05 â†’ 06 â†’
10 â†’ 11 â†’ 12 â†’ 13 â†’ 14 â†’ 15 â†’ 16 â†’ 17 â†’ 18 â†’ 19 â†’ 20 â†’
25 â†’ 28 â†’ 31 â†’
20250927 (missing_tables) â†’ 20250927 (audit_logs) â†’ 20250927 (safe_audit) â†’
40 (ìµœì¢… RPC í•¨ìˆ˜) â†’
41 (target_list) â†’ 42 (target_key) â†’ 43 (mapping) â†’ 44 (auto_match) â†’ 45 (1:N) â†’ 46 (mgmt_number) â†’ 47 (UI í•¨ìˆ˜)
```

---

## ğŸš¨ ì¤‘ìš” ì£¼ì˜ì‚¬í•­

### RPC í•¨ìˆ˜ ì°¸ì¡° ì‹œ
- âœ… **40ë²ˆ íŒŒì¼ë§Œ ì°¸ì¡°**
- âŒ 09ë²ˆ, 23ë²ˆ ì ˆëŒ€ ì°¸ì¡° ê¸ˆì§€ (ì˜ëª»ëœ ìŠ¤í‚¤ë§ˆ)

### ìƒˆ Migration ì‘ì„± ì‹œ
1. `/supabase/ACTUAL_SCHEMA_REFERENCE.md` í™•ì¸
2. `/supabase/COMPLETE_MIGRATION_GUIDE.md` ìˆ™ì§€
3. `information_schema.columns`ë¡œ ì‹¤ì œ ìŠ¤í‚¤ë§ˆ ì¬í™•ì¸

### ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€ ì»¬ëŸ¼
```
health_center_id     âŒ
region_code          âŒ
city_code            âŒ
device_serial        âŒ
device_serial_number âŒ
institution_name     âŒ (ì‹¤ì œ: installation_institution)
category             âŒ (ì‹¤ì œ: category_1, category_2, category_3)
```

### 41-46ë²ˆ ë§¤ì¹­ ì‹œìŠ¤í…œ ì‚¬ìš© ì‹œ
- âœ… ì‹¤ì œ ìŠ¤í‚¤ë§ˆ í™•ì¸: `installation_institution` (NOT `institution_name`)
- âœ… category ì£¼ì˜: `category_1, category_2, category_3` (NOT `category`)
- âœ… ì‹¤í–‰ ìˆœì„œ ì¤€ìˆ˜: 41 â†’ 42 â†’ 43 â†’ 44 â†’ 45 â†’ 46

---

## ğŸ“š ì°¸ì¡° ë¬¸ì„œ
- `ACTUAL_SCHEMA_REFERENCE.md` - ì‹¤ì œ ìŠ¤í‚¤ë§ˆ ì •ì˜
- `COMPLETE_MIGRATION_GUIDE.md` - Migration ì‘ì„± ê°€ì´ë“œ
- `00_MIGRATION_WARNING.md` - ê²½ê³  ë° ì£¼ì˜ì‚¬í•­
- `MIGRATION_AUDIT_REPORT.md` - ì „ì²´ ê°ì‚¬ ë³´ê³ ì„œ
- `EXECUTE_MANAGEMENT_NUMBER_MATCHING.md` - ë§¤ì¹­ ì‹œìŠ¤í…œ ì‹¤í–‰ ê°€ì´ë“œ

---

## âœ… ì •ë¦¬ ì™„ë£Œ
- 34ê°œ â†’ 30ê°œë¡œ ìµœì¢… ì •ë¦¬ (ì‹ ê·œ 6ê°œ ì¶”ê°€)
- ì˜ëª»ëœ ìŠ¤í‚¤ë§ˆ íŒŒì¼ ëª¨ë‘ ë³´ê´€
- ìµœì¢… ì„±ê³µ ë²„ì „ (40ë²ˆ) ìœ ì§€
- êµ¬ë¹„ì˜ë¬´ê¸°ê´€ ë§¤ì¹­ ì‹œìŠ¤í…œ (41-46ë²ˆ) ì¶”ê°€
- ë¬¸ì„œí™” ì™„ë£Œ

**ìµœì¢… ì—…ë°ì´íŠ¸: 2025-10-04**
