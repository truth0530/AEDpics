# Migration íŒŒì¼ ê°ì‚¬ ë³´ê³ ì„œ

## ê²€í†  ì¼ì: 2025-10-04 (ìµœì¢… ì—…ë°ì´íŠ¸)

## ğŸ“Š ì „ì²´ í˜„í™©
- ì´ íŒŒì¼ ìˆ˜: 41ê°œ
- ê²€í†  ëŒ€ìƒ: 41ê°œ
- ë³´ê´€ ê¶Œì¥: 15ê°œ
- ìœ ì§€ í•„ìš”: 31ê°œ (ì‹ ê·œ 7ê°œ ì¶”ê°€)

---

## âœ… ìœ ì§€í•´ì•¼ í•  Migration (31ê°œ)

### í•µì‹¬ ìŠ¤í‚¤ë§ˆ (í•„ìˆ˜)
1. âœ… `01_initial_schema.sql` - ê¸°ë³¸ í…Œì´ë¸” (organizations, user_profiles)
2. âœ… `02_initial_data.sql` - ì´ˆê¸° ë°ì´í„°
3. âœ… `03_rls_policies.sql` - RLS ì •ì±…
4. âœ… `04_aed_tables.sql` - AED ë°ì´í„° í…Œì´ë¸”

### ê¸°ëŠ¥ ê´€ë ¨ (í•„ìˆ˜)
5. âœ… `05_team_management.sql` - íŒ€ ê´€ë¦¬
6. âœ… `06_fix_inspection_schema.sql` - ì ê²€ ìŠ¤í‚¤ë§ˆ ìˆ˜ì •
7. âœ… `10_aed_data_rls_policy.sql` - AED ë°ì´í„° RLS
8. âœ… `11_create_notifications.sql` - ì•Œë¦¼ í…Œì´ë¸”
9. âœ… `12_fix_notification_policies.sql` - ì•Œë¦¼ ì •ì±… ìˆ˜ì •
10. âœ… `13_add_last_login.sql` - ë§ˆì§€ë§‰ ë¡œê·¸ì¸
11. âœ… `14_login_tracking.sql` - ë¡œê·¸ì¸ ì¶”ì 
12. âœ… `15_organization_changes.sql` - ì¡°ì§ ë³€ê²½
13. âœ… `16_inspection_schedule_entries.sql` - ì ê²€ ìŠ¤ì¼€ì¤„
14. âœ… `17_duplicate_equipment_handling.sql` - ì¤‘ë³µ ì¥ë¹„ ì²˜ë¦¬
15. âœ… `18_notification_system.sql` - ì•Œë¦¼ ì‹œìŠ¤í…œ
16. âœ… `19_gps_issues_table.sql` - GPS ì´ìŠˆ í…Œì´ë¸”
17. âœ… `20_create_inspection_sessions.sql` - ì ê²€ ì„¸ì…˜
18. âœ… `25_otp_rate_limiting.sql` - OTP ì œí•œ
19. âœ… `28_add_field_changes_to_sessions.sql` - í•„ë“œ ë³€ê²½ ì¶”ì 
20. âœ… `31_add_coordinates_to_organizations.sql` - ì¡°ì§ ì¢Œí‘œ ì¶”ê°€
21. âœ… `20250927_create_missing_tables.sql` - ëˆ„ë½ í…Œì´ë¸” ìƒì„± (2025ë…„ 9ì›”)
22. âœ… `20250927_create_audit_logs.sql` - ê°ì‚¬ ë¡œê·¸ (2025ë…„ 9ì›”)
23. âœ… `20250927_safe_audit_logs_setup.sql` - ì•ˆì „í•œ ê°ì‚¬ ë¡œê·¸ ì„¤ì • (2025ë…„ 9ì›”)

### **ìµœì¢… ì„±ê³µí•œ RPC í•¨ìˆ˜ (ì¤‘ìš”!)**
24. â­ **`40_fix_varchar_text_mismatch.sql`** - get_aed_data_filtered ìµœì¢… ë²„ì „

### **2025-10-04 ì‹ ê·œ ì¶”ê°€: êµ¬ë¹„ì˜ë¬´ê¸°ê´€ ë§¤ì¹­ ì‹œìŠ¤í…œ (7ê°œ)**
25. ğŸ†• **`41_target_list_2024_upload.sql`** - êµ¬ë¹„ì˜ë¬´ê¸°ê´€ ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” ìƒì„±
26. ğŸ†• **`42_target_key_generation.sql`** - target_key ìë™ ìƒì„± ë¡œì§
27. ğŸ†• **`43_aed_target_mapping.sql`** - AED â†” êµ¬ë¹„ì˜ë¬´ê¸°ê´€ ì˜ì†ì„± ë§¤í•‘ í…Œì´ë¸”
28. ğŸ†• **`44_auto_matching_function.sql`** - ìë™ ë§¤ì¹­ ì•Œê³ ë¦¬ì¦˜ (equipment_serial ê¸°ë°˜)
29. ğŸ†• **`45_fix_one_to_many_mapping.sql`** - 1:N ë§¤í•‘ ì§€ì› (1 ê¸°ê´€ â†’ N ê´€ë¦¬ë²ˆí˜¸)
30. ğŸ†• **`46_auto_match_management_number.sql`** - ê´€ë¦¬ë²ˆí˜¸ ê¸°ë°˜ ê·¸ë£¹ ë§¤ì¹­
31. ğŸ†• **`47_target_matching_ui_functions.sql`** - ë§¤ì¹­ ê´€ë¦¬ UI ì§€ì› í•¨ìˆ˜
    - get_target_matching_list_2024() - UIìš© ë§¤ì¹­ ëª©ë¡ ì¡°íšŒ
    - ì‹ ë¢°ë„/ì§€ì—­/ê²€ìƒ‰/í™•ì • ì—¬ë¶€ í•„í„°ë§
    - âš ï¸ ëª¨ë“  VARCHAR ì»¬ëŸ¼ì— ::VARCHAR ìºìŠ¤íŒ… ì ìš©

---

## ğŸ—‘ï¸ ì‚­ì œ/ë³´ê´€ ê¶Œì¥ Migration (15ê°œ)

### ì˜ëª»ëœ ìŠ¤í‚¤ë§ˆë¥¼ ê°€ì§„ RPC í•¨ìˆ˜ë“¤ (ì‚­ì œ ê¶Œì¥)
1. âŒ `07_health_center_mapping.sql` - ì˜ëª»ëœ health_center_id ì‚¬ìš©
2. âŒ `08_health_center_initial_data.sql` - ì˜ëª»ëœ ìŠ¤í‚¤ë§ˆ ë°ì´í„°
3. âŒ `09_aed_query_functions.sql` - ì˜¤ë˜ëœ RPC í•¨ìˆ˜ (40ë²ˆìœ¼ë¡œ ëŒ€ì²´ë¨)
4. âŒ `23_aed_query_functions_complete.sql` - ì˜¤ë˜ëœ RPC í•¨ìˆ˜ (40ë²ˆìœ¼ë¡œ ëŒ€ì²´ë¨)

### ë¡¤ë°±/ì¤‘ë³µ íŒŒì¼ (ì‚­ì œ ê¶Œì¥)
5. âŒ `26_region_code_migration.sql` - ì˜ëª»ëœ region_code ì¶”ê°€ ì‹œë„
6. âŒ `26_region_code_migration_rollback.sql` - ìœ„ì˜ ë¡¤ë°±
7. âŒ `27_persistent_mapping_table.sql` - region_code ë§¤í•‘ í…Œì´ë¸” (ë¶ˆí•„ìš”)

### ì„ì‹œ/í…ŒìŠ¤íŠ¸ íŒŒì¼ (ì‚­ì œ ê¶Œì¥)
8. âŒ `APPLY_PENDING_MIGRATIONS.sql` - ì„ì‹œ ì‹¤í–‰ íŒŒì¼
9. âŒ `ESSENTIAL_MIGRATIONS_2025_10_04_v3.sql` - **ì˜ëª»ëœ ìŠ¤í‚¤ë§ˆ í¬í•¨!**
10. âŒ `RUN_THIS_FOR_AED_MAP.sql` - ì„ì‹œ ì‹¤í–‰ íŒŒì¼

---

## ğŸ”¥ ì¦‰ì‹œ ì‚­ì œí•´ì•¼ í•  íŒŒì¼ (ìœ„í—˜!)

### **`ESSENTIAL_MIGRATIONS_2025_10_04_v3.sql`** âš ï¸
- **ì´ìœ **: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì»¬ëŸ¼ ì°¸ì¡° (health_center_id, region_code ë“±)
- **ì˜í–¥**: í˜¼ë€ì˜ ê·¼ì›, ì˜ëª»ëœ ì°¸ì¡° ë¬¸ì„œ
- **ì¡°ì¹˜**: ì¦‰ì‹œ ì‚­ì œ ë˜ëŠ” _archiveë¡œ ì´ë™

---

## ğŸ“ ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­

### 1ë‹¨ê³„: ì¦‰ì‹œ ë³´ê´€
```bash
cd /Users/kwangsunglee/Projects/AED_check2025/aed-check-system/supabase/migrations

# ì˜ëª»ëœ ìŠ¤í‚¤ë§ˆ íŒŒì¼ë“¤ ë³´ê´€
mv 07_health_center_mapping.sql _archive_failed_attempts/
mv 08_health_center_initial_data.sql _archive_failed_attempts/
mv 09_aed_query_functions.sql _archive_failed_attempts/
mv 23_aed_query_functions_complete.sql _archive_failed_attempts/
mv 26_region_code_migration.sql _archive_failed_attempts/
mv 26_region_code_migration_rollback.sql _archive_failed_attempts/
mv 27_persistent_mapping_table.sql _archive_failed_attempts/

# ì„ì‹œ íŒŒì¼ë“¤ ë³´ê´€
mv APPLY_PENDING_MIGRATIONS.sql _archive_failed_attempts/
mv ESSENTIAL_MIGRATIONS_2025_10_04_v3.sql _archive_failed_attempts/
mv RUN_THIS_FOR_AED_MAP.sql _archive_failed_attempts/
```

### 2ë‹¨ê³„: ìµœì¢… ì •ë¦¬ í™•ì¸
ë³´ê´€ í›„ ë‚¨ëŠ” íŒŒì¼:
- 01-06: ê¸°ë³¸ ìŠ¤í‚¤ë§ˆ
- 10-20: ê¸°ëŠ¥ ì¶”ê°€
- 25, 28, 31: ê¸°ëŠ¥ ê°œì„ 
- 20250127, 20250927: ëˆ„ë½ í…Œì´ë¸”/ê°ì‚¬ ë¡œê·¸
- **40: ìµœì¢… RPC í•¨ìˆ˜** â­
- **41-46: êµ¬ë¹„ì˜ë¬´ê¸°ê´€ ë§¤ì¹­ ì‹œìŠ¤í…œ** ğŸ†•

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### ì´ë¯¸ ì‹¤í–‰ëœ Migrationì€?
- SupabaseëŠ” ì‹¤í–‰ëœ migrationì„ `supabase_migrations` í…Œì´ë¸”ì— ê¸°ë¡
- íŒŒì¼ì„ ì‚­ì œí•´ë„ ì´ë¯¸ ì‹¤í–‰ëœ ê²ƒì€ ì˜í–¥ ì—†ìŒ
- ë‹¨, í–¥í›„ ì°¸ì¡°/í˜¼ë€ ë°©ì§€ë¥¼ ìœ„í•´ ì •ë¦¬ í•„ìš”

### 40ë²ˆ ì´í›„ ìƒˆ RPC í•¨ìˆ˜ê°€ í•„ìš”í•˜ë©´?
- **ì ˆëŒ€ 09ë²ˆ, 23ë²ˆ ì°¸ì¡°í•˜ì§€ ë§ ê²ƒ**
- **40ë²ˆì„ ê¸°ì¤€ìœ¼ë¡œ ìˆ˜ì •**
- **ì‹¤ì œ ìŠ¤í‚¤ë§ˆ ì¬í™•ì¸** (`information_schema.columns`)

### 41-47ë²ˆ êµ¬ë¹„ì˜ë¬´ê¸°ê´€ ë§¤ì¹­ ì‹œìŠ¤í…œ ì‚¬ìš© ì‹œ
- **ë°˜ë“œì‹œ ì‹¤ì œ ìŠ¤í‚¤ë§ˆ í™•ì¸**: `installation_institution` (NOT `institution_name`)
- **category ì£¼ì˜**: `category_1, category_2, category_3` (NOT `category`)
- **VARCHAR ìºìŠ¤íŒ… í•„ìˆ˜**: ëª¨ë“  VARCHAR ì»¬ëŸ¼ì— `::VARCHAR` ëª…ì‹œ
- **ì‹¤í–‰ ìˆœì„œ**: 41 â†’ 42 â†’ 43 â†’ 44 â†’ 45 â†’ 46 â†’ 47

---

## ğŸ¯ ìµœì¢… ê¶Œì¥ì‚¬í•­

1. âœ… **ì¦‰ì‹œ**: ESSENTIAL_MIGRATIONS_2025_10_04_v3.sql ì‚­ì œ
2. âœ… **ë‹¨ê¸°**: ì˜ëª»ëœ ìŠ¤í‚¤ë§ˆ íŒŒì¼ 9ê°œ ë³´ê´€
3. âœ… **ì¥ê¸°**: Migration 40ë²ˆì„ ì •ìƒ ì‘ë™ ê¸°ì¤€ìœ¼ë¡œ ìœ ì§€
4. ğŸ†• **ì‹ ê·œ**: 41-47ë²ˆ êµ¬ë¹„ì˜ë¬´ê¸°ê´€ ë§¤ì¹­ ì‹œìŠ¤í…œ ìˆœì°¨ ì‹¤í–‰
5. âš ï¸ **ì£¼ì˜**: 47ë²ˆì€ VARCHAR ìºìŠ¤íŒ… ê·œì¹™ ì™„ë²½ ì¤€ìˆ˜

## ê²€í† ì: Claude
## ìµœì¢… ì—…ë°ì´íŠ¸: 2025-10-04 (êµ¬ë¹„ì˜ë¬´ê¸°ê´€ ë§¤ì¹­ ì‹œìŠ¤í…œ ì¶”ê°€)
