# Migration 47 ì„¤ëª…ì„œ

## ğŸ“‹ ê°œìš”

**íŒŒì¼ëª…**: `47_target_matching_ui_functions.sql`
**ì‘ì„±ì¼**: 2025-10-04
**ëª©ì **: êµ¬ë¹„ì˜ë¬´ê¸°ê´€ ë§¤ì¹­ ê´€ë¦¬ UIë¥¼ ìœ„í•œ PostgreSQL í•¨ìˆ˜ ì œê³µ

---

## ğŸ¯ ì£¼ìš” ê¸°ëŠ¥

### 1. `get_target_matching_list_2024()` í•¨ìˆ˜
UIì—ì„œ 50,010ê±´ì˜ management_numberë³„ ë§¤ì¹­ ì •ë³´ë¥¼ ì¡°íšŒí•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.

#### íŒŒë¼ë¯¸í„°
- `p_confidence_level` (VARCHAR): ì‹ ë¢°ë„ í•„í„°
  - `'high'`: 90ì  ì´ìƒ (10,630ê±´ / 21.3%)
  - `'medium'`: 70-89ì  (8,810ê±´ / 17.6%)
  - `'low'`: 70ì  ë¯¸ë§Œ (30,570ê±´ / 61.1%)
  - `'all'`: ì „ì²´ (50,010ê±´)

- `p_sido` (VARCHAR): ì§€ì—­ í•„í„° (ì˜ˆ: 'ì„œìš¸íŠ¹ë³„ì‹œ')
  - NULLì´ë©´ ì „ì²´ ì§€ì—­ ì¡°íšŒ

- `p_search` (VARCHAR): ê²€ìƒ‰ì–´
  - AED ì„¤ì¹˜ê¸°ê´€ëª…, êµ¬ë¹„ì˜ë¬´ê¸°ê´€ëª…, ê´€ë¦¬ë²ˆí˜¸ì—ì„œ ê²€ìƒ‰
  - NULLì´ë©´ ê²€ìƒ‰ ì•ˆí•¨

- `p_confirmed_only` (BOOLEAN): í™•ì •ëœ ê²ƒë§Œ ë³´ê¸°
  - TRUE: í™•ì •ëœ ë§¤ì¹­ë§Œ ì¡°íšŒ
  - FALSE: ì „ì²´ ì¡°íšŒ

#### ë°˜í™˜ ì»¬ëŸ¼
```sql
management_number        VARCHAR    -- ê´€ë¦¬ë²ˆí˜¸ (ì˜ˆ: M-2024-001)
target_key_2024          VARCHAR    -- í™•ì •ëœ êµ¬ë¹„ì˜ë¬´ê¸°ê´€ í‚¤
auto_suggested_2024      VARCHAR    -- ìë™ ë§¤ì¹­ ì¶”ì²œ í‚¤
auto_confidence_2024     NUMERIC    -- ì‹ ë¢°ë„ ì ìˆ˜ (50-100)
confirmed_2024           BOOLEAN    -- í™•ì • ì—¬ë¶€
modified_2024            BOOLEAN    -- ìˆ˜ì • ì—¬ë¶€
modified_by_2024         VARCHAR    -- ìˆ˜ì •ì
modified_at_2024         TIMESTAMPTZ -- ìˆ˜ì •ì¼ì‹œ
aed_institution          VARCHAR    -- AED ì„¤ì¹˜ê¸°ê´€ëª…
target_institution       VARCHAR    -- êµ¬ë¹„ì˜ë¬´ê¸°ê´€ëª…
sido                     VARCHAR    -- ì‹œë„
gugun                    VARCHAR    -- ì‹œêµ°êµ¬
aed_count                BIGINT     -- í•´ë‹¹ ê´€ë¦¬ë²ˆí˜¸ì˜ AED ìˆ˜ëŸ‰
matching_reason          JSONB      -- ë§¤ì¹­ ì´ìœ  (ì ìˆ˜ ìƒì„¸)
```

---

## âš ï¸ íƒ€ì… ìºìŠ¤íŒ… ê·œì¹™ ì¤€ìˆ˜

ì´ Migrationì€ ê¸°ì¡´ 40ì—¬ ì°¨ë¡€ì˜ ì‹¤íŒ¨ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ **ì™„ë²½í•œ íƒ€ì… ìºìŠ¤íŒ… ê·œì¹™**ì„ ì¤€ìˆ˜í•©ë‹ˆë‹¤.

### ì£¼ìš” ì ìš© ì‚¬í•­

#### 1. MAX() í•¨ìˆ˜ ê²°ê³¼ ìºìŠ¤íŒ…
```sql
-- âŒ ì˜ëª»ëœ ì˜ˆ (TEXT ë°˜í™˜)
MAX(a.installation_institution) as aed_institution

-- âœ… ì˜¬ë°”ë¥¸ ì˜ˆ (VARCHAR ë°˜í™˜)
MAX(a.installation_institution)::VARCHAR as aed_institution
```

#### 2. ëª¨ë“  VARCHAR ì»¬ëŸ¼ ëª…ì‹œì  ìºìŠ¤íŒ…
```sql
-- CTEì—ì„œ ì´ë¯¸ ::VARCHAR ìºìŠ¤íŒ…ì„ í–ˆì–´ë„
-- ìµœì¢… SELECTì—ì„œ ë‹¤ì‹œ í•œ ë²ˆ ìºìŠ¤íŒ…!
a.aed_institution::VARCHAR,  -- ì¬ìºìŠ¤íŒ…
a.sido::VARCHAR,             -- ì¬ìºìŠ¤íŒ…
a.gugun::VARCHAR,            -- ì¬ìºìŠ¤íŒ…
```

#### 3. ì‹¤ì œ ìŠ¤í‚¤ë§ˆ ì»¬ëŸ¼ëª… ì‚¬ìš©
```sql
-- âœ… ì˜¬ë°”ë¥¸ ì»¬ëŸ¼ëª…
installation_institution  (NOT institution_name)
category_1, category_2, category_3  (NOT category)
```

---

## ğŸ“Š ì‚¬ìš© ì˜ˆì œ

### ì˜ˆì œ 1: ê³ ì‹ ë¢°ë„ ë§¤ì¹­ 10ê±´ ì¡°íšŒ
```sql
SELECT * FROM get_target_matching_list_2024('high', NULL, NULL, FALSE)
LIMIT 10;
```
**ê²°ê³¼**: 90ì  ì´ìƒ ê³ ì‹ ë¢°ë„ ë§¤ì¹­ 10ê±´

### ì˜ˆì œ 2: ì„œìš¸ ì§€ì—­ ë§¤ì¹­ ì¡°íšŒ
```sql
SELECT * FROM get_target_matching_list_2024('all', 'ì„œìš¸íŠ¹ë³„ì‹œ', NULL, FALSE)
LIMIT 10;
```
**ê²°ê³¼**: ì„œìš¸íŠ¹ë³„ì‹œ ì§€ì—­ì˜ ëª¨ë“  ë§¤ì¹­

### ì˜ˆì œ 3: ê¸°ê´€ëª… ê²€ìƒ‰
```sql
SELECT * FROM get_target_matching_list_2024('all', NULL, 'í•œêµ­ì² ë„', FALSE)
LIMIT 10;
```
**ê²°ê³¼**: 'í•œêµ­ì² ë„'ê°€ í¬í•¨ëœ ê¸°ê´€ ê²€ìƒ‰

### ì˜ˆì œ 4: í™•ì •ëœ ë§¤ì¹­ë§Œ ì¡°íšŒ
```sql
SELECT * FROM get_target_matching_list_2024('all', NULL, NULL, TRUE);
```
**ê²°ê³¼**: ë³´ê±´ì†Œ ë‹´ë‹¹ìê°€ í™•ì •í•œ ë§¤ì¹­ë§Œ ì¡°íšŒ

### ì˜ˆì œ 5: í†µê³„ í™•ì¸
```sql
SELECT
  CASE
    WHEN auto_confidence_2024 >= 90 THEN 'high'
    WHEN auto_confidence_2024 >= 70 THEN 'medium'
    ELSE 'low'
  END as level,
  COUNT(*) as count
FROM management_number_group_mapping
GROUP BY level
ORDER BY level;
```
**ê²°ê³¼**:
```
level   | count
--------|-------
high    | 10,630  (21.3%)
low     | 30,570  (61.1%)
medium  | 8,810   (17.6%)
```

---

## ğŸ”— ê´€ë ¨ íŒŒì¼

### ë°ì´í„°ë² ì´ìŠ¤ Migration
- `41_target_list_2024_upload.sql` - êµ¬ë¹„ì˜ë¬´ê¸°ê´€ 26,724ê±´ ì—…ë¡œë“œ
- `42_target_key_generation.sql` - target_key ìë™ ìƒì„±
- `43_aed_target_mapping.sql` - ì˜ì†ì„± ë§¤í•‘ í…Œì´ë¸”
- `44_auto_matching_function.sql` - equipment_serial ê¸°ë°˜ ë§¤ì¹­ (íê¸°)
- `45_fix_one_to_many_mapping.sql` - 1:N ë§¤í•‘ ì§€ì›
- `46_auto_match_management_number.sql` - ê´€ë¦¬ë²ˆí˜¸ ê·¸ë£¹ ë§¤ì¹­ (50,010ê±´)
- **`47_target_matching_ui_functions.sql`** â† í˜„ì¬ íŒŒì¼

### UI/UX íŒŒì¼
- `/app/(authenticated)/admin/target-matching/page.tsx` - í˜ì´ì§€ ë˜í¼
- `/app/(authenticated)/admin/target-matching/TargetMatchingClient.tsx` - React UI ì»´í¬ë„ŒíŠ¸

### API ì—”ë“œí¬ì¸íŠ¸
- `/api/target-matching/stats/route.ts` - í†µê³„ ì¡°íšŒ
- `/api/target-matching/route.ts` - ëª©ë¡ ì¡°íšŒ (ì´ í•¨ìˆ˜ í˜¸ì¶œ)
- `/api/target-matching/confirm/route.ts` - ë§¤ì¹­ í™•ì •
- `/api/target-matching/modify/route.ts` - ë§¤ì¹­ ìˆ˜ì •
- `/api/target-matching/bulk-confirm/route.ts` - ì¼ê´„ í™•ì •

---

## ğŸš€ ì‹¤í–‰ ë°©ë²•

### Supabase Dashboardì—ì„œ ì‹¤í–‰ (ê¶Œì¥)

1. [Supabase Dashboard](https://supabase.com/dashboard) ì ‘ì†
2. í”„ë¡œì íŠ¸ ì„ íƒ
3. **SQL Editor** ë©”ë‰´ í´ë¦­
4. **New Query** ë²„íŠ¼ í´ë¦­
5. `47_target_matching_ui_functions.sql` íŒŒì¼ ë‚´ìš© ë³µì‚¬
6. ë¶™ì—¬ë„£ê¸° í›„ **Run** ë²„íŠ¼ í´ë¦­
7. ì„±ê³µ ë©”ì‹œì§€ í™•ì¸

### ì‹¤í–‰ ê²°ê³¼ í™•ì¸
```sql
-- í•¨ìˆ˜ ìƒì„± í™•ì¸
SELECT routine_name, routine_type
FROM information_schema.routines
WHERE routine_name = 'get_target_matching_list_2024';

-- ê²°ê³¼:
-- routine_name                    | routine_type
-- -------------------------------|-------------
-- get_target_matching_list_2024  | FUNCTION
```

---

## ğŸ¨ UI í™”ë©´ êµ¬ì„±

Migration 47 ì‹¤í–‰ í›„ `/admin/target-matching` í˜ì´ì§€ì—ì„œ ì‚¬ìš© ê°€ëŠ¥:

### ëŒ€ì‹œë³´ë“œ í†µê³„
- ì „ì²´ ë§¤ì¹­: 50,010ê±´
- ì´ AED ì»¤ë²„ë¦¬ì§€: 80,860ëŒ€ (100%)
- í™•ì • ì™„ë£Œ: 0ê±´ â†’ ì ì§„ì  ì¦ê°€
- ê²€í†  ëŒ€ê¸°: 50,010ê±´ â†’ ì ì§„ì  ê°ì†Œ
- í‰ê·  ì‹ ë¢°ë„: 69.81ì 

### íƒ­ êµ¬ì„±
1. **ê³ ì‹ ë¢°ë„** (10,630ê±´) - ë…¹ìƒ‰ ë°°ì§€
   - ì¼ê´„ í™•ì • ë²„íŠ¼ ì œê³µ
   - ì‹ ë¢°ë„ 90ì  ì´ìƒ

2. **ì¤‘ì‹ ë¢°ë„** (8,810ê±´) - ë…¸ë€ìƒ‰ ë°°ì§€
   - ê°œë³„ ê²€í†  í•„ìš”
   - ì‹ ë¢°ë„ 70-89ì 

3. **ì €ì‹ ë¢°ë„** (30,570ê±´) - ì£¼í™©ìƒ‰ ë°°ì§€
   - ìƒì„¸ ê²€í†  í•„ìš”
   - ì‹ ë¢°ë„ 50-69ì 

4. **ì „ì²´** (50,010ê±´) - íŒŒë€ìƒ‰ ë°°ì§€

### í•„í„°ë§ ê¸°ëŠ¥
- **ì§€ì—­ ì„ íƒ**: 17ê°œ ì‹œë„ ë“œë¡­ë‹¤ìš´
- **ê²€ìƒ‰**: ê¸°ê´€ëª…, ê´€ë¦¬ë²ˆí˜¸ ê²€ìƒ‰
- **í™•ì • ì—¬ë¶€**: ì²´í¬ë°•ìŠ¤ í† ê¸€

### ì•¡ì…˜ ë²„íŠ¼
- **í™•ì •**: ê°œë³„ ë§¤ì¹­ í™•ì •
- **ìƒì„¸**: ë§¤ì¹­ ì´ìœ  ë° ì ìˆ˜ ìƒì„¸ ë³´ê¸°
- **ê³ ì‹ ë¢°ë„ ì¼ê´„ í™•ì •**: 10,630ê±´ í•œ ë²ˆì— í™•ì •

---

## ğŸ“ ì£¼ì˜ì‚¬í•­

### 1. ì‹¤í–‰ ìˆœì„œ
Migration 46 ì´í›„ì— ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤:
```
41 â†’ 42 â†’ 43 â†’ 44 â†’ 45 â†’ 46 â†’ 47 (í˜„ì¬)
```

### 2. ê¶Œí•œ
`authenticated` ì‚¬ìš©ìë§Œ í•¨ìˆ˜ ì‹¤í–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤.

### 3. ì„±ëŠ¥
ëŒ€ìš©ëŸ‰ ë°ì´í„°ì´ë¯€ë¡œ í•„í„°ë§ ê¶Œì¥:
- ì§€ì—­ë³„ë¡œ ë‚˜ëˆ ì„œ ì¡°íšŒ
- ì‹ ë¢°ë„ë³„ë¡œ ë‚˜ëˆ ì„œ ì¡°íšŒ
- LIMIT ì‚¬ìš© ê¶Œì¥

### 4. íƒ€ì… ì•ˆì •ì„±
ëª¨ë“  VARCHAR ì»¬ëŸ¼ì— ëª…ì‹œì  ìºìŠ¤íŒ… ì ìš©ë˜ì–´ íƒ€ì… ì—ëŸ¬ ì—†ìŒì„ ë³´ì¥í•©ë‹ˆë‹¤.

---

## ğŸ” íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### Q1: í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ë‹¤ëŠ” ì—ëŸ¬
```
ERROR: function get_target_matching_list_2024 does not exist
```
**í•´ê²°**: Migration 47ì„ ì‹¤í–‰í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. SQL Editorì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”.

### Q2: ë°ì´í„°ê°€ ì—†ìŒ
```
ë°˜í™˜ ê²°ê³¼: 0 rows
```
**í•´ê²°**: Migration 46 ì‹¤í–‰ ë° auto_match_management_numbers_batch() ì‹¤í–‰ í™•ì¸
```sql
SELECT COUNT(*) FROM management_number_group_mapping;
-- ê²°ê³¼: 50010ì´ì–´ì•¼ í•¨
```

### Q3: UIì—ì„œ ë¡œë”©ë§Œ ê³„ì†ë¨
**í•´ê²°**:
1. ë¸Œë¼ìš°ì € ì½˜ì†” í™•ì¸ (F12)
2. Network íƒ­ì—ì„œ API ì‘ë‹µ í™•ì¸
3. Supabase RLS ì •ì±… í™•ì¸

---

## ğŸ“ˆ ì˜ˆìƒ ì„±ëŠ¥

### ì¿¼ë¦¬ ì„±ëŠ¥
- **ì „ì²´ ì¡°íšŒ**: ~2-3ì´ˆ (50,010ê±´)
- **ê³ ì‹ ë¢°ë„ë§Œ**: ~1ì´ˆ (10,630ê±´)
- **ì§€ì—­ í•„í„°**: ~500ms (í‰ê·  3,000ê±´)
- **ê²€ìƒ‰**: ~1-2ì´ˆ (ì¸ë±ìŠ¤ ë¯¸ì ìš©)

### ìµœì í™” ê¶Œì¥ì‚¬í•­
```sql
-- management_number_group_mapping ì¸ë±ìŠ¤ ì¶”ê°€ (ì˜µì…˜)
CREATE INDEX IF NOT EXISTS idx_mgmt_confidence
ON management_number_group_mapping(auto_confidence_2024);

CREATE INDEX IF NOT EXISTS idx_mgmt_confirmed
ON management_number_group_mapping(confirmed_2024);
```

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

ì‹¤í–‰ ì „ í™•ì¸:
- [ ] Migration 41-46 ëª¨ë‘ ì‹¤í–‰ ì™„ë£Œ
- [ ] management_number_group_mapping í…Œì´ë¸”ì— 50,010ê±´ ì¡´ì¬
- [ ] target_list_2024 í…Œì´ë¸”ì— 26,724ê±´ ì¡´ì¬
- [ ] aed_data í…Œì´ë¸”ì— 80,000+ ê±´ ì¡´ì¬

ì‹¤í–‰ í›„ í™•ì¸:
- [ ] í•¨ìˆ˜ ìƒì„± í™•ì¸ (information_schema.routines)
- [ ] í…ŒìŠ¤íŠ¸ ì¿¼ë¦¬ ì‹¤í–‰ ì„±ê³µ
- [ ] UI í˜ì´ì§€ ì ‘ì† ê°€ëŠ¥ (/admin/target-matching)
- [ ] í†µê³„ ì •ìƒ í‘œì‹œ (50,010 / 80,860)

---

## ğŸ“š ì°¸ê³  ë¬¸ì„œ

- `/supabase/migrations/00_MIGRATION_WARNING.md` - íƒ€ì… ìºìŠ¤íŒ… ê²½ê³ 
- `/supabase/TYPE_CASTING_MANDATORY_RULES.md` - ìºìŠ¤íŒ… í•„ìˆ˜ ê·œì¹™
- `/supabase/ACTUAL_SCHEMA_REFERENCE.md` - ì‹¤ì œ ìŠ¤í‚¤ë§ˆ ì°¸ì¡°
- `/supabase/migrations/MIGRATION_AUDIT_REPORT.md` - ì „ì²´ Migration ê°ì‚¬
- `/supabase/EXECUTE_MIGRATION_47.md` - ì‹¤í–‰ ê°€ì´ë“œ

---

## ì‘ì„±ì: Claude
## ìµœì¢… ì—…ë°ì´íŠ¸: 2025-10-04
## Migration ë²„ì „: 47 (êµ¬ë¹„ì˜ë¬´ê¸°ê´€ ë§¤ì¹­ UI)
