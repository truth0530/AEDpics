# Migration 47 설명서

## 📋 개요

**파일명**: `47_target_matching_ui_functions.sql`
**작성일**: 2025-10-04
**목적**: 구비의무기관 매칭 관리 UI를 위한 PostgreSQL 함수 제공

---

## 🎯 주요 기능

### 1. `get_target_matching_list_2024()` 함수
UI에서 50,010건의 management_number별 매칭 정보를 조회하는 함수입니다.

#### 파라미터
- `p_confidence_level` (VARCHAR): 신뢰도 필터
  - `'high'`: 90점 이상 (10,630건 / 21.3%)
  - `'medium'`: 70-89점 (8,810건 / 17.6%)
  - `'low'`: 70점 미만 (30,570건 / 61.1%)
  - `'all'`: 전체 (50,010건)

- `p_sido` (VARCHAR): 지역 필터 (예: '서울특별시')
  - NULL이면 전체 지역 조회

- `p_search` (VARCHAR): 검색어
  - AED 설치기관명, 구비의무기관명, 관리번호에서 검색
  - NULL이면 검색 안함

- `p_confirmed_only` (BOOLEAN): 확정된 것만 보기
  - TRUE: 확정된 매칭만 조회
  - FALSE: 전체 조회

#### 반환 컬럼
```sql
management_number        VARCHAR    -- 관리번호 (예: M-2024-001)
target_key_2024          VARCHAR    -- 확정된 구비의무기관 키
auto_suggested_2024      VARCHAR    -- 자동 매칭 추천 키
auto_confidence_2024     NUMERIC    -- 신뢰도 점수 (50-100)
confirmed_2024           BOOLEAN    -- 확정 여부
modified_2024            BOOLEAN    -- 수정 여부
modified_by_2024         VARCHAR    -- 수정자
modified_at_2024         TIMESTAMPTZ -- 수정일시
aed_institution          VARCHAR    -- AED 설치기관명
target_institution       VARCHAR    -- 구비의무기관명
sido                     VARCHAR    -- 시도
gugun                    VARCHAR    -- 시군구
aed_count                BIGINT     -- 해당 관리번호의 AED 수량
matching_reason          JSONB      -- 매칭 이유 (점수 상세)
```

---

## ⚠️ 타입 캐스팅 규칙 준수

이 Migration은 기존 40여 차례의 실패 경험을 바탕으로 **완벽한 타입 캐스팅 규칙**을 준수합니다.

### 주요 적용 사항

#### 1. MAX() 함수 결과 캐스팅
```sql
-- ❌ 잘못된 예 (TEXT 반환)
MAX(a.installation_institution) as aed_institution

-- ✅ 올바른 예 (VARCHAR 반환)
MAX(a.installation_institution)::VARCHAR as aed_institution
```

#### 2. 모든 VARCHAR 컬럼 명시적 캐스팅
```sql
-- CTE에서 이미 ::VARCHAR 캐스팅을 했어도
-- 최종 SELECT에서 다시 한 번 캐스팅!
a.aed_institution::VARCHAR,  -- 재캐스팅
a.sido::VARCHAR,             -- 재캐스팅
a.gugun::VARCHAR,            -- 재캐스팅
```

#### 3. 실제 스키마 컬럼명 사용
```sql
-- ✅ 올바른 컬럼명
installation_institution  (NOT institution_name)
category_1, category_2, category_3  (NOT category)
```

---

## 📊 사용 예제

### 예제 1: 고신뢰도 매칭 10건 조회
```sql
SELECT * FROM get_target_matching_list_2024('high', NULL, NULL, FALSE)
LIMIT 10;
```
**결과**: 90점 이상 고신뢰도 매칭 10건

### 예제 2: 서울 지역 매칭 조회
```sql
SELECT * FROM get_target_matching_list_2024('all', '서울특별시', NULL, FALSE)
LIMIT 10;
```
**결과**: 서울특별시 지역의 모든 매칭

### 예제 3: 기관명 검색
```sql
SELECT * FROM get_target_matching_list_2024('all', NULL, '한국철도', FALSE)
LIMIT 10;
```
**결과**: '한국철도'가 포함된 기관 검색

### 예제 4: 확정된 매칭만 조회
```sql
SELECT * FROM get_target_matching_list_2024('all', NULL, NULL, TRUE);
```
**결과**: 보건소 담당자가 확정한 매칭만 조회

### 예제 5: 통계 확인
```sql
SELECT
  CASE
    WHEN auto_confidence_2024 >= 90 THEN 'high'
    WHEN auto_confidence_2024 >= 70 THEN 'medium'
    ELSE 'low'
  END as level,
  COUNT(*) as count
FROM management_number_group_mapping
GROUP BY level
ORDER BY level;
```
**결과**:
```
level   | count
--------|-------
high    | 10,630  (21.3%)
low     | 30,570  (61.1%)
medium  | 8,810   (17.6%)
```

---

## 🔗 관련 파일

### 데이터베이스 Migration
- `41_target_list_2024_upload.sql` - 구비의무기관 26,724건 업로드
- `42_target_key_generation.sql` - target_key 자동 생성
- `43_aed_target_mapping.sql` - 영속성 매핑 테이블
- `44_auto_matching_function.sql` - equipment_serial 기반 매칭 (폐기)
- `45_fix_one_to_many_mapping.sql` - 1:N 매핑 지원
- `46_auto_match_management_number.sql` - 관리번호 그룹 매칭 (50,010건)
- **`47_target_matching_ui_functions.sql`** ← 현재 파일

### UI/UX 파일
- `/app/(authenticated)/admin/target-matching/page.tsx` - 페이지 래퍼
- `/app/(authenticated)/admin/target-matching/TargetMatchingClient.tsx` - React UI 컴포넌트

### API 엔드포인트
- `/api/target-matching/stats/route.ts` - 통계 조회
- `/api/target-matching/route.ts` - 목록 조회 (이 함수 호출)
- `/api/target-matching/confirm/route.ts` - 매칭 확정
- `/api/target-matching/modify/route.ts` - 매칭 수정
- `/api/target-matching/bulk-confirm/route.ts` - 일괄 확정

---

## 🚀 실행 방법

### Supabase Dashboard에서 실행 (권장)

1. [Supabase Dashboard](https://supabase.com/dashboard) 접속
2. 프로젝트 선택
3. **SQL Editor** 메뉴 클릭
4. **New Query** 버튼 클릭
5. `47_target_matching_ui_functions.sql` 파일 내용 복사
6. 붙여넣기 후 **Run** 버튼 클릭
7. 성공 메시지 확인

### 실행 결과 확인
```sql
-- 함수 생성 확인
SELECT routine_name, routine_type
FROM information_schema.routines
WHERE routine_name = 'get_target_matching_list_2024';

-- 결과:
-- routine_name                    | routine_type
-- -------------------------------|-------------
-- get_target_matching_list_2024  | FUNCTION
```

---

## 🎨 UI 화면 구성

Migration 47 실행 후 `/admin/target-matching` 페이지에서 사용 가능:

### 대시보드 통계
- 전체 매칭: 50,010건
- 총 AED 커버리지: 80,860대 (100%)
- 확정 완료: 0건 → 점진적 증가
- 검토 대기: 50,010건 → 점진적 감소
- 평균 신뢰도: 69.81점

### 탭 구성
1. **고신뢰도** (10,630건) - 녹색 배지
   - 일괄 확정 버튼 제공
   - 신뢰도 90점 이상

2. **중신뢰도** (8,810건) - 노란색 배지
   - 개별 검토 필요
   - 신뢰도 70-89점

3. **저신뢰도** (30,570건) - 주황색 배지
   - 상세 검토 필요
   - 신뢰도 50-69점

4. **전체** (50,010건) - 파란색 배지

### 필터링 기능
- **지역 선택**: 17개 시도 드롭다운
- **검색**: 기관명, 관리번호 검색
- **확정 여부**: 체크박스 토글

### 액션 버튼
- **확정**: 개별 매칭 확정
- **상세**: 매칭 이유 및 점수 상세 보기
- **고신뢰도 일괄 확정**: 10,630건 한 번에 확정

---

## 📝 주의사항

### 1. 실행 순서
Migration 46 이후에 실행해야 합니다:
```
41 → 42 → 43 → 44 → 45 → 46 → 47 (현재)
```

### 2. 권한
`authenticated` 사용자만 함수 실행 가능합니다.

### 3. 성능
대용량 데이터이므로 필터링 권장:
- 지역별로 나눠서 조회
- 신뢰도별로 나눠서 조회
- LIMIT 사용 권장

### 4. 타입 안정성
모든 VARCHAR 컬럼에 명시적 캐스팅 적용되어 타입 에러 없음을 보장합니다.

---

## 🔍 트러블슈팅

### Q1: 함수를 찾을 수 없다는 에러
```
ERROR: function get_target_matching_list_2024 does not exist
```
**해결**: Migration 47을 실행하지 않았습니다. SQL Editor에서 실행하세요.

### Q2: 데이터가 없음
```
반환 결과: 0 rows
```
**해결**: Migration 46 실행 및 auto_match_management_numbers_batch() 실행 확인
```sql
SELECT COUNT(*) FROM management_number_group_mapping;
-- 결과: 50010이어야 함
```

### Q3: UI에서 로딩만 계속됨
**해결**:
1. 브라우저 콘솔 확인 (F12)
2. Network 탭에서 API 응답 확인
3. Supabase RLS 정책 확인

---

## 📈 예상 성능

### 쿼리 성능
- **전체 조회**: ~2-3초 (50,010건)
- **고신뢰도만**: ~1초 (10,630건)
- **지역 필터**: ~500ms (평균 3,000건)
- **검색**: ~1-2초 (인덱스 미적용)

### 최적화 권장사항
```sql
-- management_number_group_mapping 인덱스 추가 (옵션)
CREATE INDEX IF NOT EXISTS idx_mgmt_confidence
ON management_number_group_mapping(auto_confidence_2024);

CREATE INDEX IF NOT EXISTS idx_mgmt_confirmed
ON management_number_group_mapping(confirmed_2024);
```

---

## ✅ 체크리스트

실행 전 확인:
- [ ] Migration 41-46 모두 실행 완료
- [ ] management_number_group_mapping 테이블에 50,010건 존재
- [ ] target_list_2024 테이블에 26,724건 존재
- [ ] aed_data 테이블에 80,000+ 건 존재

실행 후 확인:
- [ ] 함수 생성 확인 (information_schema.routines)
- [ ] 테스트 쿼리 실행 성공
- [ ] UI 페이지 접속 가능 (/admin/target-matching)
- [ ] 통계 정상 표시 (50,010 / 80,860)

---

## 📚 참고 문서

- `/supabase/migrations/00_MIGRATION_WARNING.md` - 타입 캐스팅 경고
- `/supabase/TYPE_CASTING_MANDATORY_RULES.md` - 캐스팅 필수 규칙
- `/supabase/ACTUAL_SCHEMA_REFERENCE.md` - 실제 스키마 참조
- `/supabase/migrations/MIGRATION_AUDIT_REPORT.md` - 전체 Migration 감사
- `/supabase/EXECUTE_MIGRATION_47.md` - 실행 가이드

---

## 작성자: Claude
## 최종 업데이트: 2025-10-04
## Migration 버전: 47 (구비의무기관 매칭 UI)
