name: Verify and Fix Session Status Enum

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform (check/fix)'
        required: true
        type: choice
        options:
          - check
          - fix

jobs:
  verify-enum:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Verify and Fix Enum Type
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.NCP_HOST }}
        username: ${{ secrets.NCP_USERNAME }}
        key: ${{ secrets.NCP_SSH_KEY }}
        port: ${{ secrets.NCP_SSH_PORT }}
        script: |
          cd /var/www/aedpics

          echo "=== Extracting database credentials ==="
          DB_USER=$(echo "$DATABASE_URL" | sed -n 's|.*://\([^:]*\):.*|\1|p')
          DB_PASS=$(echo "$DATABASE_URL" | sed -n 's|.*://[^:]*:\([^@]*\)@.*|\1|p')
          DB_HOST=$(echo "$DATABASE_URL" | sed -n 's|.*@\([^:]*\):.*|\1|p')
          DB_PORT=$(echo "$DATABASE_URL" | sed -n 's|.*:\([0-9]*\)/.*|\1|p')
          DB_NAME=$(echo "$DATABASE_URL" | sed -n 's|.*/\([^?]*\).*|\1|p')

          echo "Database: $DB_NAME@$DB_HOST:$DB_PORT"
          echo "User: $DB_USER"

          if [ "${{ github.event.inputs.action }}" = "check" ]; then
            echo ""
            echo "=== Checking session_status enum existence ==="
            PGPASSWORD="$DB_PASS" psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -c "
              SELECT EXISTS (
                SELECT 1 FROM pg_type
                WHERE typname = 'session_status'
                  AND typnamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'aedpics')
              ) AS enum_exists;
            "

            echo ""
            echo "=== Checking inspection_sessions.status column type ==="
            PGPASSWORD="$DB_PASS" psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -c "
              SELECT
                table_schema,
                table_name,
                column_name,
                data_type,
                udt_name
              FROM information_schema.columns
              WHERE table_schema = 'aedpics'
                AND table_name = 'inspection_sessions'
                AND column_name = 'status';
            "

            echo ""
            echo "=== Checking enum values (if exists) ==="
            PGPASSWORD="$DB_PASS" psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -c "
              SELECT enumlabel
              FROM pg_enum
              WHERE enumtypid = (
                SELECT oid FROM pg_type
                WHERE typname = 'session_status'
                  AND typnamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'aedpics')
              )
              ORDER BY enumsortorder;
            "
          else
            echo ""
            echo "=== Creating session_status enum if not exists ==="
            PGPASSWORD="$DB_PASS" psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" <<'SQL'
            DO $$
            BEGIN
                IF NOT EXISTS (
                    SELECT 1 FROM pg_type
                    WHERE typname = 'session_status'
                      AND typnamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'aedpics')
                ) THEN
                    CREATE TYPE "aedpics"."session_status" AS ENUM (
                        'active',
                        'in_progress',
                        'completed',
                        'cancelled',
                        'paused'
                    );
                    RAISE NOTICE 'Created session_status enum';
                ELSE
                    RAISE NOTICE 'session_status enum already exists';
                END IF;
            END $$;
SQL

            echo ""
            echo "=== Converting inspection_sessions.status column type ==="
            PGPASSWORD="$DB_PASS" psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" <<'SQL'
            DO $$
            DECLARE
                v_column_type TEXT;
            BEGIN
                SELECT data_type INTO v_column_type
                FROM information_schema.columns
                WHERE table_schema = 'aedpics'
                  AND table_name = 'inspection_sessions'
                  AND column_name = 'status';

                IF v_column_type = 'USER-DEFINED' THEN
                    RAISE NOTICE 'inspection_sessions.status is already an enum';
                ELSIF v_column_type IN ('character varying', 'text') THEN
                    RAISE NOTICE 'Converting inspection_sessions.status from % to enum', v_column_type;

                    ALTER TABLE "aedpics"."inspection_sessions"
                    ALTER COLUMN "status" TYPE "aedpics"."session_status"
                    USING "status"::text::"aedpics"."session_status";

                    RAISE NOTICE 'Conversion completed successfully';
                ELSE
                    RAISE WARNING 'Unknown column type: %', v_column_type;
                END IF;
            END $$;
SQL

            echo ""
            echo "=== Verification ==="
            PGPASSWORD="$DB_PASS" psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -c "
              SELECT
                data_type,
                udt_name
              FROM information_schema.columns
              WHERE table_schema = 'aedpics'
                AND table_name = 'inspection_sessions'
                AND column_name = 'status';
            "

            echo ""
            echo "=== Regenerating Prisma Client ==="
            npx prisma generate

            echo ""
            echo "=== Reloading PM2 ==="
            pm2 reload ecosystem.config.cjs

            echo ""
            echo "=== Waiting for restart ==="
            sleep 5

            echo ""
            echo "=== Checking PM2 status ==="
            pm2 status

            echo ""
            echo "=== Checking recent logs ==="
            pm2 logs --nostream --lines 30 | grep -E "Ready|error|session_status" || pm2 logs --nostream --lines 30
          fi

          echo ""
          echo "=== Operation completed ==="
