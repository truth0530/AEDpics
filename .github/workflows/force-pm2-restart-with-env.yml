name: Force PM2 Restart with Environment

on:
  workflow_dispatch:

jobs:
  restart:
    name: Delete and Restart PM2
    runs-on: ubuntu-latest

    steps:
    - name: Force PM2 restart to reload .env.production
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.NCP_HOST }}
        username: ${{ secrets.NCP_USERNAME }}
        key: ${{ secrets.NCP_SSH_KEY }}
        port: ${{ secrets.NCP_SSH_PORT }}
        script: |
          cd /var/www/aedpics

          echo "=== 1. Verify .env.production ==="
          if [ -f ".env.production" ]; then
            echo "✅ .env.production exists"
            echo ""
            echo "Environment variables:"
            grep -E "NEXTAUTH_URL|NEXT_PUBLIC_SITE_URL|NODE_ENV" .env.production
          else
            echo "❌ .env.production NOT FOUND!"
            exit 1
          fi

          echo ""
          echo "=== 2. Delete existing PM2 processes ==="
          pm2 delete aedpics || echo "Process not found, will create new"

          echo ""
          echo "=== 3. Start PM2 with fresh environment ==="
          pm2 start ecosystem.config.cjs

          echo ""
          echo "=== 4. Wait for processes to stabilize ==="
          sleep 10

          echo ""
          echo "=== 5. Check PM2 Status ==="
          pm2 status aedpics

          echo ""
          echo "=== 6. Save PM2 configuration ==="
          pm2 save

          echo ""
          echo "=== 7. Test NextAuth URLs ==="
          sleep 5
          PROVIDERS_RESPONSE=$(curl -s https://aed.pics/api/auth/providers)
          echo "$PROVIDERS_RESPONSE" | jq '.'

          echo ""
          echo "=== 8. Verify URLs ==="
          SIGNIN_URL=$(echo "$PROVIDERS_RESPONSE" | jq -r '.credentials.signinUrl')
          echo "SignIn URL: $SIGNIN_URL"

          if [[ "$SIGNIN_URL" == https://aed.pics* ]]; then
            echo "✅ SUCCESS: NextAuth now uses https://aed.pics"
            echo "✅ Users can now login and logout without issues"
          else
            echo "❌ FAILED: Still using wrong URL: $SIGNIN_URL"
            echo ""
            echo "=== Additional Debug Info ==="
            pm2 env 0
            exit 1
          fi
