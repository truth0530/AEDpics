name: Validate Region Codes

on:
  schedule:
    # 매일 새벽 2시에 실행 (한국 시간 기준 오전 11시)
    - cron: '0 17 * * *'
  push:
    branches:
      - main
      - develop
    paths:
      - 'lib/constants/regions.ts'
      - 'scripts/**/*.ts'
      - '.github/workflows/validate-region-codes.yml'
  workflow_dispatch:
    inputs:
      fix:
        description: 'Fix invalid codes automatically'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  validate-codes:
    name: Validate Region and City Codes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Check City Codes
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "=== Checking City Codes ==="
          npm run check:city-codes || EXIT_CODE=$?

          if [ "${EXIT_CODE:-0}" -ne 0 ]; then
            echo "::warning::City codes validation failed"
            exit 1
          fi

      - name: Check Region Codes
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "=== Checking Region Codes ==="
          npm run check:region-codes || EXIT_CODE=$?

          if [ "${EXIT_CODE:-0}" -ne 0 ]; then
            echo "::warning::Region codes validation failed"
            exit 1
          fi

      - name: Run Unified Mapping Validation
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "=== Running Unified Mapping Validation ==="
          npx tsx scripts/unified-city-mapping.ts validate || EXIT_CODE=$?

          if [ "${EXIT_CODE:-0}" -ne 0 ]; then
            echo "::warning::Unified mapping validation failed"
            exit 1
          fi

      - name: Generate Statistics Report
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "=== Generating Statistics Report ==="
          npx tsx scripts/unified-city-mapping.ts stats

      - name: Auto Fix (if requested)
        if: github.event.inputs.fix == 'true'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "=== Auto-fixing invalid codes ==="
          npm run fix:city-codes
          npm run fix:region-codes
          npx tsx scripts/unified-city-mapping.ts fix

      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '⚠️ Region/City Code Validation Failed',
              body: `## Validation Failed

              The automated validation of region and city codes has failed.

              **Workflow Run:** [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              **Triggered by:** ${context.eventName}
              **Branch:** ${context.ref}

              ### Action Required
              1. Review the workflow logs
              2. Run \`npm run check:city-codes\` locally
              3. Run \`npm run check:region-codes\` locally
              4. Fix any invalid codes using the fix scripts

              ### Fix Commands
              \`\`\`bash
              npm run fix:city-codes
              npm run fix:region-codes
              \`\`\`
              `,
              labels: ['bug', 'data-integrity', 'automated']
            });

            console.log(`Created issue #${issue.data.number}`);

  summary:
    name: Generate Summary Report
    runs-on: ubuntu-latest
    needs: validate-codes
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## Region/City Code Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate-codes.result }}" == "success" ]; then
            echo "✅ **All validations passed successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Validation failed - manual intervention required**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
            echo "1. Check the workflow logs" >> $GITHUB_STEP_SUMMARY
            echo "2. Run validation locally" >> $GITHUB_STEP_SUMMARY
            echo "3. Fix invalid codes" >> $GITHUB_STEP_SUMMARY
            echo "4. Push the fixes" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Time:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY