name: Deploy to NCP Production

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:  # 수동 실행 가능

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Cache Next.js build
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          ${{ github.workspace }}/.next/cache
        key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
        restore-keys: |
          ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-

    - name: Install dependencies
      run: npm ci

    - name: Generate Prisma Client
      run: npx prisma generate
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}

    - name: Run tests and build
      run: |
        npm run tsc || true
        npm run lint
        NEXT_PUBLIC_SITE_URL="${NEXT_PUBLIC_SITE_URL:-http://localhost:3000}" \
        NEXTAUTH_URL="${NEXTAUTH_URL:-http://localhost:3000}" \
        npm run build
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
        NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        NEXT_PUBLIC_KAKAO_MAP_APP_KEY: ${{ secrets.NEXT_PUBLIC_KAKAO_MAP_APP_KEY }}
        NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}
        RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        MASTER_EMAIL: ${{ secrets.MASTER_EMAIL }}
        ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}

    - name: Deploy to NCP Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.NCP_HOST }}
        username: ${{ secrets.NCP_USERNAME }}
        key: ${{ secrets.NCP_SSH_KEY }}
        port: ${{ secrets.NCP_SSH_PORT }}
        envs: DATABASE_URL,NEXTAUTH_URL,NEXTAUTH_SECRET,JWT_SECRET,NEXT_PUBLIC_KAKAO_MAP_APP_KEY,NEXT_PUBLIC_SITE_URL,RESEND_API_KEY,MASTER_EMAIL,ENCRYPTION_KEY,NCP_ACCESS_KEY,NCP_ACCESS_SECRET,NCP_SENDER_EMAIL,NCP_OBJECT_STORAGE_REGION,NCP_OBJECT_STORAGE_ENDPOINT,NCP_OBJECT_STORAGE_ACCESS_KEY,NCP_OBJECT_STORAGE_SECRET_KEY,NCP_OBJECT_STORAGE_BUCKET
        script: |
          set -e  # Exit on any error
          cd /var/www/aedpics

          echo "=== Phase 0: Disk space cleanup ==="
          echo "Checking disk usage before cleanup..."
          df -h | grep -E '/$|Filesystem'

          echo "Cleaning build caches..."
          rm -rf .next/cache
          rm -rf .next.backup

          echo "Cleaning PM2 logs..."
          pm2 flush || true

          echo "Checking disk usage after cleanup..."
          df -h | grep -E '/$|Filesystem'

          echo "=== Phase 1: Backup current version ==="
          if [ -d ".next" ]; then
            echo "Backing up current build (excluding cache)..."
            rm -rf .next.backup
            mkdir -p .next.backup
            rsync -a --exclude='cache' .next/ .next.backup/
            echo "Backup created: .next.backup (cache excluded)"
          else
            echo "No existing build to backup (first deployment)"
          fi

          echo "=== Phase 2: Update code and dependencies ==="
          echo "Creating .env.production file..."
          echo "DATABASE_URL=\"$DATABASE_URL\"" > .env.production
          echo "NEXTAUTH_URL=\"$NEXTAUTH_URL\"" >> .env.production
          echo "NEXTAUTH_SECRET=\"$NEXTAUTH_SECRET\"" >> .env.production
          echo "JWT_SECRET=\"$JWT_SECRET\"" >> .env.production
          echo "NEXT_PUBLIC_KAKAO_MAP_APP_KEY=\"$NEXT_PUBLIC_KAKAO_MAP_APP_KEY\"" >> .env.production
          echo "NEXT_PUBLIC_SITE_URL=\"$NEXT_PUBLIC_SITE_URL\"" >> .env.production
          echo "RESEND_API_KEY=\"$RESEND_API_KEY\"" >> .env.production
          echo "MASTER_EMAIL=\"$MASTER_EMAIL\"" >> .env.production
          echo "ENCRYPTION_KEY=\"$ENCRYPTION_KEY\"" >> .env.production
          echo "NCP_ACCESS_KEY=\"$NCP_ACCESS_KEY\"" >> .env.production
          echo "NCP_ACCESS_SECRET=\"$NCP_ACCESS_SECRET\"" >> .env.production
          echo "NCP_SENDER_EMAIL=\"$NCP_SENDER_EMAIL\"" >> .env.production
          echo "NCP_OBJECT_STORAGE_REGION=\"$NCP_OBJECT_STORAGE_REGION\"" >> .env.production
          echo "NCP_OBJECT_STORAGE_ENDPOINT=\"$NCP_OBJECT_STORAGE_ENDPOINT\"" >> .env.production
          echo "NCP_OBJECT_STORAGE_ACCESS_KEY=\"$NCP_OBJECT_STORAGE_ACCESS_KEY\"" >> .env.production
          echo "NCP_OBJECT_STORAGE_SECRET_KEY=\"$NCP_OBJECT_STORAGE_SECRET_KEY\"" >> .env.production
          echo "NCP_OBJECT_STORAGE_BUCKET=\"$NCP_OBJECT_STORAGE_BUCKET\"" >> .env.production

          echo "Updating code from repository..."
          git fetch origin
          git reset --hard origin/main

          echo "Cleaning node_modules..."
          rm -rf node_modules package-lock.json

          echo "Installing dependencies..."
          npm install

          echo "Generating Prisma client..."
          npx prisma generate

          echo "=== Phase 2.5: Run database migrations ==="
          echo "Checking for pending migrations..."
          if [ -f "scripts/migrate-database.js" ]; then
            echo "Running database migrations..."
            if node scripts/migrate-database.js; then
              echo "Migration successful!"
            else
              echo "ERROR: Migration failed!"
              echo "Deployment aborted."
              exit 1
            fi
          else
            echo "No migration script found. Skipping migrations."
          fi

          echo "=== Phase 3: Build new version ==="
          echo "Cleaning PWA cache files..."
          rm -rf public/sw.js public/sw.js.map public/workbox-*.js public/workbox-*.js.map
          rm -rf public/swe-worker-*.js public/swe-worker-*.js.map

          echo "Exporting environment variables for build..."
          export NEXT_PUBLIC_KAKAO_MAP_APP_KEY="$NEXT_PUBLIC_KAKAO_MAP_APP_KEY"
          export NEXT_PUBLIC_SITE_URL="$NEXT_PUBLIC_SITE_URL"

          echo "Building application with timestamp..."
          export BUILD_TIMESTAMP=$(date +%s)

          if npm run build; then
            echo "Build successful!"
          else
            echo "Build failed! Rolling back..."
            if [ -d ".next.backup" ]; then
              rm -rf .next
              mv .next.backup .next
              echo "Rollback complete. Deployment aborted."
            fi
            exit 1
          fi

          echo "=== Phase 4: Validate build artifacts ==="
          if [ ! -d ".next" ]; then
            echo "ERROR: .next directory not found!"
            if [ -d ".next.backup" ]; then
              mv .next.backup .next
            fi
            exit 1
          fi

          if [ ! -d ".next/server" ] || [ ! -d ".next/static" ]; then
            echo "ERROR: Build incomplete! Missing server or static directory."
            rm -rf .next
            if [ -d ".next.backup" ]; then
              mv .next.backup .next
            fi
            exit 1
          fi

          echo "Build validation passed!"
          echo "Creating cache bust files..."
          echo "$BUILD_TIMESTAMP" > .next/BUILD_ID
          echo "$BUILD_TIMESTAMP" > public/build-timestamp.txt

          echo "=== Phase 5: Zero-Downtime deployment with PM2 ==="
          if pm2 describe aedpics > /dev/null 2>&1; then
            echo "App is running. Performing zero-downtime reload..."
            if pm2 reload ecosystem.config.cjs --update-env; then
              echo "PM2 reload successful!"

              echo "Waiting for application to stabilize (15 seconds)..."
              sleep 15

              if pm2 describe aedpics | grep -q "online"; then
                echo "Application is online and stable!"
                rm -rf .next.backup
                echo "Backup removed."
              else
                echo "ERROR: Application failed to start after reload!"
                echo "Rolling back to previous version..."
                rm -rf .next
                mv .next.backup .next
                pm2 reload ecosystem.config.cjs --update-env
                exit 1
              fi
            else
              echo "ERROR: PM2 reload failed!"
              echo "Rolling back to previous version..."
              rm -rf .next
              if [ -d ".next.backup" ]; then
                mv .next.backup .next
                pm2 reload ecosystem.config.cjs --update-env
              fi
              exit 1
            fi
          else
            echo "App is not running. Starting for the first time..."
            pm2 start ecosystem.config.cjs --update-env
            echo "Waiting for application to start (15 seconds)..."
            sleep 15

            if pm2 describe aedpics | grep -q "online"; then
              echo "Application started successfully!"
            else
              echo "ERROR: Application failed to start!"
              exit 1
            fi
          fi

          pm2 save --force

          echo "=== Phase 6: Cache cleanup ==="
          echo "Clearing Nginx cache..."
          rm -rf /var/cache/nginx/* || true

          echo "Reloading Nginx..."
          systemctl reload nginx || true

          echo "=== Deployment complete! ==="
          echo "Build timestamp: $BUILD_TIMESTAMP"
          pm2 status aedpics
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
        NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        NEXT_PUBLIC_KAKAO_MAP_APP_KEY: ${{ secrets.NEXT_PUBLIC_KAKAO_MAP_APP_KEY }}
        NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}
        RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        MASTER_EMAIL: ${{ secrets.MASTER_EMAIL }}
        ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
        NCP_ACCESS_KEY: ${{ secrets.NCP_ACCESS_KEY }}
        NCP_ACCESS_SECRET: ${{ secrets.NCP_ACCESS_SECRET }}
        NCP_SENDER_EMAIL: ${{ secrets.NCP_SENDER_EMAIL }}
        NCP_OBJECT_STORAGE_REGION: ${{ secrets.NCP_OBJECT_STORAGE_REGION }}
        NCP_OBJECT_STORAGE_ENDPOINT: ${{ secrets.NCP_OBJECT_STORAGE_ENDPOINT }}
        NCP_OBJECT_STORAGE_ACCESS_KEY: ${{ secrets.NCP_OBJECT_STORAGE_ACCESS_KEY }}
        NCP_OBJECT_STORAGE_SECRET_KEY: ${{ secrets.NCP_OBJECT_STORAGE_SECRET_KEY }}
        NCP_OBJECT_STORAGE_BUCKET: ${{ secrets.NCP_OBJECT_STORAGE_BUCKET }}

    - name: Health Check
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.NCP_HOST }}
        username: ${{ secrets.NCP_USERNAME }}
        key: ${{ secrets.NCP_SSH_KEY }}
        port: ${{ secrets.NCP_SSH_PORT }}
        script: |
          echo "=== Final Health Check ==="

          echo "Checking PM2 process status..."
          if ! pm2 describe aedpics | grep -q "online"; then
            echo "ERROR: PM2 process is not online!"
            pm2 logs aedpics --lines 50 --nostream
            exit 1
          fi
          echo "PM2 process is online."

          echo "Checking application HTTP response..."
          MAX_RETRIES=5
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s -o /dev/null http://localhost:3000; then
              echo "Application is responding to HTTP requests!"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Attempt $RETRY_COUNT failed. Retrying in 3 seconds..."
                sleep 3
              else
                echo "ERROR: Application failed to respond after $MAX_RETRIES attempts!"
                pm2 logs aedpics --lines 50 --nostream
                exit 1
              fi
            fi
          done

          echo "=== Health Check Passed ==="
          pm2 status aedpics
          curl -I http://localhost:3000

    - name: Notify deployment success
      if: success()
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            text: "Production deployment successful",
            attachments: [{
              color: 'good',
              text: `Deployed to NCP Production\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}`
            }]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Notify deployment failure
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            text: "Production deployment failed",
            attachments: [{
              color: 'danger',
              text: `Failed to deploy to NCP Production\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}`
            }]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
