name: Deploy to NCP Production

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  # Phase 1: Code checks (lint, TypeScript)
  checks:
    name: Code Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run ESLint
      run: npm run lint

    - name: Run TypeScript check
      run: npm run tsc || true

  # Phase 2: Build Next.js application
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: checks

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Cache Next.js build
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/.next/cache
        key: ${{ runner.os }}-nextjs-build-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-nextjs-build-

    - name: Install dependencies
      run: npm ci

    - name: Generate Prisma Client
      run: npx prisma generate
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}

    - name: Build Next.js application
      run: |
        NEXT_PUBLIC_SITE_URL="${NEXT_PUBLIC_SITE_URL:-http://localhost:3000}" \
        NEXTAUTH_URL="${NEXTAUTH_URL:-http://localhost:3000}" \
        npm run build
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
        NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        NEXT_PUBLIC_KAKAO_MAP_APP_KEY: ${{ secrets.NEXT_PUBLIC_KAKAO_MAP_APP_KEY }}
        NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}
        RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        MASTER_EMAIL: ${{ secrets.MASTER_EMAIL }}
        ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nextjs-build
        path: .next
        retention-days: 1

  # Phase 3: Database migrations
  migrate:
    name: Database Migrations
    runs-on: ubuntu-latest
    needs: build
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Prisma CLI
      run: npm install -D prisma

    - name: Check and apply migrations
      run: |
        if [ -d "prisma/migrations" ] && [ "$(ls -A prisma/migrations)" ]; then
          echo "Checking migration status..."
          if npx prisma migrate status 2>&1 | grep -q "Database schema is up to date"; then
            echo "Database schema is already up to date"
          elif npx prisma migrate status 2>&1 | grep -q "following migrations have not yet been applied"; then
            echo "Applying pending migrations..."
            if npx prisma migrate deploy --skip-seed; then
              echo "Migrations applied successfully"
            else
              echo "WARNING: Migration deploy failed, continuing deployment..."
            fi
          fi
        else
          echo "No migrations to apply"
        fi
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      continue-on-error: true

  # Phase 4: Production deployment
  deploy:
    name: Deploy to NCP
    runs-on: ubuntu-latest
    needs: [ build, migrate ]
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: nextjs-build
        path: .next

    - name: Deploy to NCP Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.NCP_HOST }}
        username: ${{ secrets.NCP_USERNAME }}
        key: ${{ secrets.NCP_SSH_KEY }}
        port: ${{ secrets.NCP_SSH_PORT }}
        envs: DATABASE_URL,NEXTAUTH_URL,NEXTAUTH_SECRET,JWT_SECRET,NEXT_PUBLIC_KAKAO_MAP_APP_KEY,NEXT_PUBLIC_SITE_URL,RESEND_API_KEY,MASTER_EMAIL,ENCRYPTION_KEY,NCP_ACCESS_KEY,NCP_ACCESS_SECRET,NCP_SENDER_EMAIL,NCP_OBJECT_STORAGE_REGION,NCP_OBJECT_STORAGE_ENDPOINT,NCP_OBJECT_STORAGE_ACCESS_KEY,NCP_OBJECT_STORAGE_SECRET_KEY,NCP_OBJECT_STORAGE_BUCKET
        script: |
          set -e
          cd /var/www/aedpics

          echo "=== Phase 0: Pre-deployment Disk Space Monitoring ==="

          get_disk_usage() {
            df / | awk 'NR==2 {print $5}' | sed 's/%//'
          }

          echo "Checking disk usage BEFORE cleanup..."
          DISK_BEFORE=$(get_disk_usage)
          df -h | grep -E '/$|Filesystem'
          echo "Disk usage: ${DISK_BEFORE}%"
          echo ""

          echo "Running aggressive disk space cleanup..."
          echo "1. Cleaning build caches..."
          rm -rf .next/cache .next.backup 2>/dev/null || true

          echo "2. Cleaning npm cache..."
          npm cache clean --force 2>/dev/null || true

          echo "3. Cleaning PM2 logs..."
          pm2 flush 2>/dev/null || true

          echo "4. Cleaning old log files..."
          find /var/log -type f -mtime +30 -delete 2>/dev/null || true

          echo ""
          echo "Checking disk usage AFTER cleanup..."
          DISK_AFTER=$(get_disk_usage)
          df -h | grep -E '/$|Filesystem'
          echo "Disk usage: ${DISK_AFTER}%"
          echo ""

          if [ ${DISK_AFTER} -gt 90 ]; then
            echo "ERROR: Disk usage is ${DISK_AFTER}% (critical level > 90%)"
            if [ -d ".next.backup" ]; then
              echo "Deleting .next.backup..."
              rm -rf .next.backup
            fi

            DISK_CRITICAL=$(get_disk_usage)
            if [ ${DISK_CRITICAL} -gt 85 ]; then
              echo "FATAL: Disk usage still critical. Deployment aborted."
              exit 1
            fi
          fi

          if [ ${DISK_AFTER} -gt 80 ]; then
            echo "WARNING: Disk usage is ${DISK_AFTER}%"
          else
            echo "OK: Disk usage is ${DISK_AFTER}%"
          fi
          echo ""

          echo "=== Phase 1: Backup current version ==="
          if [ -d ".next" ]; then
            echo "Backing up current build..."
            rm -rf .next.backup
            mkdir -p .next.backup
            rsync -a --exclude='cache' .next/ .next.backup/
            echo "Backup created"
          fi

          echo "=== Phase 2: Update code and dependencies ==="
          echo "Creating .env.production file..."
          echo "DATABASE_URL=\"$DATABASE_URL\"" > .env.production
          echo "NEXTAUTH_URL=\"$NEXTAUTH_URL\"" >> .env.production
          echo "NEXTAUTH_SECRET=\"$NEXTAUTH_SECRET\"" >> .env.production
          echo "JWT_SECRET=\"$JWT_SECRET\"" >> .env.production
          echo "NEXT_PUBLIC_KAKAO_MAP_APP_KEY=\"$NEXT_PUBLIC_KAKAO_MAP_APP_KEY\"" >> .env.production
          echo "NEXT_PUBLIC_SITE_URL=\"$NEXT_PUBLIC_SITE_URL\"" >> .env.production
          echo "RESEND_API_KEY=\"$RESEND_API_KEY\"" >> .env.production
          echo "MASTER_EMAIL=\"$MASTER_EMAIL\"" >> .env.production
          echo "ENCRYPTION_KEY=\"$ENCRYPTION_KEY\"" >> .env.production
          echo "NCP_ACCESS_KEY=\"$NCP_ACCESS_KEY\"" >> .env.production
          echo "NCP_ACCESS_SECRET=\"$NCP_ACCESS_SECRET\"" >> .env.production
          echo "NCP_SENDER_EMAIL=\"$NCP_SENDER_EMAIL\"" >> .env.production
          echo "NCP_OBJECT_STORAGE_REGION=\"$NCP_OBJECT_STORAGE_REGION\"" >> .env.production
          echo "NCP_OBJECT_STORAGE_ENDPOINT=\"$NCP_OBJECT_STORAGE_ENDPOINT\"" >> .env.production
          echo "NCP_OBJECT_STORAGE_ACCESS_KEY=\"$NCP_OBJECT_STORAGE_ACCESS_KEY\"" >> .env.production
          echo "NCP_OBJECT_STORAGE_SECRET_KEY=\"$NCP_OBJECT_STORAGE_SECRET_KEY\"" >> .env.production
          echo "NCP_OBJECT_STORAGE_BUCKET=\"$NCP_OBJECT_STORAGE_BUCKET\"" >> .env.production

          echo "Updating code from repository..."
          git fetch origin
          git reset --hard origin/main

          echo "Installing dependencies..."
          npm install

          echo "Generating Prisma client..."
          npx prisma generate

          echo "=== Phase 3: Deploy built files ==="
          echo "Cleaning PWA cache files..."
          rm -rf public/sw.js public/sw.js.map public/workbox-*.js public/workbox-*.js.map

          echo "Validating build artifacts..."
          if [ ! -d ".next" ]; then
            echo "ERROR: .next directory not found!"
            exit 1
          fi

          if [ ! -d ".next/server" ] || [ ! -d ".next/static" ]; then
            echo "ERROR: Build incomplete! Missing server or static directory."
            exit 1
          fi

          echo "Build validation passed!"
          export BUILD_TIMESTAMP=$(date +%s)
          echo "$BUILD_TIMESTAMP" > .next/BUILD_ID
          echo "$BUILD_TIMESTAMP" > public/build-timestamp.txt

          echo "=== Phase 4: Zero-Downtime deployment with PM2 ==="
          if pm2 describe aedpics > /dev/null 2>&1; then
            echo "App is running. Performing zero-downtime reload..."
            if pm2 reload ecosystem.config.cjs --update-env; then
              echo "PM2 reload successful!"
              sleep 15

              if pm2 describe aedpics | grep -q "online"; then
                echo "Application is online and stable!"
                rm -rf .next.backup
              else
                echo "ERROR: Application failed to start after reload!"
                rm -rf .next
                mv .next.backup .next
                pm2 reload ecosystem.config.cjs --update-env
                exit 1
              fi
            else
              echo "ERROR: PM2 reload failed!"
              rm -rf .next
              if [ -d ".next.backup" ]; then
                mv .next.backup .next
                pm2 reload ecosystem.config.cjs --update-env
              fi
              exit 1
            fi
          else
            echo "App is not running. Starting for the first time..."
            pm2 start ecosystem.config.cjs --update-env
            sleep 15

            if pm2 describe aedpics | grep -q "online"; then
              echo "Application started successfully!"
            else
              echo "ERROR: Application failed to start!"
              exit 1
            fi
          fi

          pm2 save --force

          echo "=== Phase 5: Cache cleanup ==="
          echo "Clearing Nginx cache..."
          rm -rf /var/cache/nginx/* || true

          echo "Reloading Nginx..."
          systemctl reload nginx || true

          echo "=== Deployment complete! ==="
          echo "Build timestamp: $BUILD_TIMESTAMP"
          pm2 status aedpics
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
        NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        NEXT_PUBLIC_KAKAO_MAP_APP_KEY: ${{ secrets.NEXT_PUBLIC_KAKAO_MAP_APP_KEY }}
        NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}
        RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        MASTER_EMAIL: ${{ secrets.MASTER_EMAIL }}
        ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
        NCP_ACCESS_KEY: ${{ secrets.NCP_ACCESS_KEY }}
        NCP_ACCESS_SECRET: ${{ secrets.NCP_ACCESS_SECRET }}
        NCP_SENDER_EMAIL: ${{ secrets.NCP_SENDER_EMAIL }}
        NCP_OBJECT_STORAGE_REGION: ${{ secrets.NCP_OBJECT_STORAGE_REGION }}
        NCP_OBJECT_STORAGE_ENDPOINT: ${{ secrets.NCP_OBJECT_STORAGE_ENDPOINT }}
        NCP_OBJECT_STORAGE_ACCESS_KEY: ${{ secrets.NCP_OBJECT_STORAGE_ACCESS_KEY }}
        NCP_OBJECT_STORAGE_SECRET_KEY: ${{ secrets.NCP_OBJECT_STORAGE_SECRET_KEY }}
        NCP_OBJECT_STORAGE_BUCKET: ${{ secrets.NCP_OBJECT_STORAGE_BUCKET }}

    - name: Health Check
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.NCP_HOST }}
        username: ${{ secrets.NCP_USERNAME }}
        key: ${{ secrets.NCP_SSH_KEY }}
        port: ${{ secrets.NCP_SSH_PORT }}
        script: |
          echo "=== Final Health Check ==="

          echo "Checking PM2 process status..."
          if ! pm2 describe aedpics | grep -q "online"; then
            echo "ERROR: PM2 process is not online!"
            pm2 logs aedpics --lines 50 --nostream
            exit 1
          fi
          echo "PM2 process is online."

          echo "Checking application HTTP response..."
          MAX_RETRIES=5
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s -o /dev/null http://localhost:3000; then
              echo "Application is responding to HTTP requests!"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Attempt $RETRY_COUNT failed. Retrying in 3 seconds..."
                sleep 3
              else
                echo "ERROR: Application failed to respond after $MAX_RETRIES attempts!"
                pm2 logs aedpics --lines 50 --nostream
                exit 1
              fi
            fi
          done

          echo "=== Health Check Passed ==="
          pm2 status aedpics
          curl -I http://localhost:3000

    - name: Notify deployment success
      if: success()
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            text: "Production deployment successful",
            attachments: [{
              color: 'good',
              text: `Deployed to NCP Production\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}`
            }]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Notify deployment failure
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            text: "Production deployment failed",
            attachments: [{
              color: 'danger',
              text: `Failed to deploy to NCP Production\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}`
            }]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
