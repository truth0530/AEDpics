name: Restart PM2 with New Environment

on:
  workflow_dispatch:

jobs:
  restart:
    name: Restart PM2 Process
    runs-on: ubuntu-latest

    steps:
    - name: Restart PM2 to load new environment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.NCP_HOST }}
        username: ${{ secrets.NCP_USERNAME }}
        key: ${{ secrets.NCP_SSH_KEY }}
        port: ${{ secrets.NCP_SSH_PORT }}
        script: |
          cd /var/www/aedpics

          echo "=== 1. Current PM2 Status ==="
          pm2 status aedpics

          echo ""
          echo "=== 2. Verify .env.production ==="
          if [ -f ".env.production" ]; then
            echo "✅ .env.production exists"
            grep -E "NEXTAUTH_URL|NEXT_PUBLIC_SITE_URL" .env.production
          else
            echo "❌ .env.production NOT FOUND!"
            exit 1
          fi

          echo ""
          echo "=== 3. Restart PM2 (full restart to reload .env.production) ==="
          pm2 restart ecosystem.config.cjs

          echo ""
          echo "=== 4. Wait for processes to be ready ==="
          sleep 5

          echo ""
          echo "=== 5. Check PM2 Status After Restart ==="
          pm2 status aedpics

          echo ""
          echo "=== 6. Test NextAuth URLs ==="
          PROVIDERS_RESPONSE=$(curl -s https://aed.pics/api/auth/providers)
          echo "$PROVIDERS_RESPONSE" | jq '.'

          echo ""
          echo "=== 7. Verify URLs ==="
          SIGNIN_URL=$(echo "$PROVIDERS_RESPONSE" | jq -r '.credentials.signinUrl')
          echo "SignIn URL: $SIGNIN_URL"

          if [[ "$SIGNIN_URL" == https://aed.pics* ]]; then
            echo "✅ SUCCESS: NextAuth now uses https://aed.pics"
          else
            echo "❌ FAILED: Still using wrong URL: $SIGNIN_URL"
            exit 1
          fi
