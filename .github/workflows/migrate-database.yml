name: Database Migration

on:
  workflow_dispatch:  # 수동 실행 전용
    inputs:
      confirm:
        description: '마이그레이션 실행 확인 (yes 입력)'
        required: true
        default: 'no'

jobs:
  migrate:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Check confirmation
      if: github.event.inputs.confirm != 'yes'
      run: |
        echo "마이그레이션이 취소되었습니다. confirm 입력값이 'yes'가 아닙니다."
        exit 1

    - name: Run migration on NCP Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.NCP_HOST }}
        username: ${{ secrets.NCP_USERNAME }}
        key: ${{ secrets.NCP_SSH_KEY }}
        port: ${{ secrets.NCP_SSH_PORT }}
        script: |
          set -e
          cd /var/www/aedpics

          echo "=== Database Migration ==="
          echo "Current branch: $(git branch --show-current)"
          echo ""

          echo "Pulling latest code..."
          git fetch origin main
          git reset --hard origin/main

          echo "Installing dependencies..."
          npm install

          echo "Generating Prisma Client..."
          npx prisma generate

          echo "Running migration script..."
          npx ts-node scripts/migrate-database.ts
