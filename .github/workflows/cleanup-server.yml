name: Cleanup Server Disk Space

on:
  workflow_dispatch:  # 수동 실행만 가능

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
    - name: Cleanup Server Disk Space
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.NCP_HOST }}
        username: ${{ secrets.NCP_USERNAME }}
        key: ${{ secrets.NCP_SSH_KEY }}
        port: ${{ secrets.NCP_SSH_PORT }}
        script: |
          echo "=== Current Disk Usage ==="
          df -h /

          cd /var/www/aedpics

          echo "=== Cleaning build caches ==="
          # Next.js 빌드 캐시 정리
          rm -rf .next/cache
          echo "Cleaned .next/cache"

          # Node modules 캐시 정리
          if [ -d "node_modules/.cache" ]; then
            rm -rf node_modules/.cache
            echo "Cleaned node_modules/.cache"
          fi

          # NPM 캐시 정리
          npm cache clean --force
          echo "Cleaned npm cache"

          # PM2 로그 정리
          pm2 flush
          echo "Flushed PM2 logs"

          # 백업 파일 정리 (7일 이상 된 것만)
          find /var/www/aedpics -name "*.backup" -type d -mtime +7 -exec rm -rf {} + 2>/dev/null || true
          echo "Cleaned old backup files"

          # 임시 파일 정리
          rm -rf /tmp/npm-* /tmp/next-* 2>/dev/null || true
          echo "Cleaned temp files"

          # Docker 정리 (설치된 경우)
          if command -v docker &> /dev/null; then
            docker system prune -af --volumes 2>/dev/null || true
            echo "Cleaned Docker cache"
          fi

          echo "=== Disk Usage After Cleanup ==="
          df -h /

          echo "=== Directory Sizes ==="
          du -sh /var/www/aedpics/.next /var/www/aedpics/node_modules 2>/dev/null || true

          echo "=== Cleanup Complete ==="
