name: Pre-Deploy Validation

on:
  workflow_call:
    secrets:
      DATABASE_URL:
        required: true

jobs:
  validate:
    name: Pre-deployment Data Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: TypeScript Check
        run: npm run tsc

      - name: Lint Check
        run: npm run lint

      - name: Validate Region Codes
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "=== Validating Region and City Codes ==="

          # Check region codes (includes city code validation)
          if ! npm run check:region-codes; then
            echo "::error::Region/city codes validation failed. Run 'npm run fix:region-codes' to fix."
            exit 1
          fi

          echo "✅ All region and city codes are valid"

      - name: Check for Hardcoded Mappings
        run: |
          echo "=== Checking for hardcoded region mappings (excluding seed/tutorial data) ==="

          # 검사할 파일들: seed-organizations와 tutorial-guide 완전 제외
          SUSPICIOUS_FILES=$(find app/ components/ lib/ \
            -type f \( -name "*.ts" -o -name "*.tsx" \) \
            ! -path "*node_modules*" \
            ! -path "*/.next/*" \
            ! -path "*/dist/*" \
            ! -path "*seed-organizations*" \
            ! -path "*tutorial-guide*" \
            ! -name "regions.ts" \
            2>/dev/null)

          FOUND_ISSUES=false

          # 각 파일에서 하드코딩된 지역 코드 검사
          while IFS= read -r file; do
            if grep -q "city_code: ['\"]" "$file" 2>/dev/null || \
               grep -q "region_code: ['\"]" "$file" 2>/dev/null; then
              echo "⚠️ Warning: Found hardcoded mapping in $file"
              # 실제 프로덕션 코드에서 하드코딩이 발견되면 경고만 출력
              # seed와 tutorial 데이터는 이미 제외됨
            fi
          done <<< "$SUSPICIOUS_FILES"

          echo "✅ Hardcoded mapping check completed (seed/tutorial data excluded)"

      - name: Test Build
        run: |
          echo "=== Testing production build ==="
          npm run build

      - name: Generate Validation Report
        if: always()
        run: |
          echo "## Pre-Deployment Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks Performed:" >> $GITHUB_STEP_SUMMARY
          echo "- [x] TypeScript compilation" >> $GITHUB_STEP_SUMMARY
          echo "- [x] ESLint validation" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Region and city code validation" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Hardcoded mapping check" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Production build test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Validation Time:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY